# PenaltyStaking Contract Verification Handoff

**Date:** February 12, 2025  
**Status:** BLOCKED - Source code mismatch  
**Priority:** High

---

## Contract Details

| Field | Value |
|-------|-------|
| **Contract Address** | `0xa3769D111e493289e6d98D7791E286d847b4d294` |
| **Network** | Base (Chain ID 8453) |
| **Block Deployed** | 42,079,542 |
| **Deployer** | BAI Wallet |

### Verification Page
https://basescan.org/verifyContract?a=0xa3769D111e493289e6d98D7791E286d847b4d294

### BaseScan Contract Page
https://basescan.org/address/0xa3769D111e493289e6d98D7791E286d847b4d294

---

## Constructor Arguments (ABI-Encoded)

```
0000000000000000000000002ca8b2b97bc0f0ccdd875dcfeff16b868a1b5ba30000000000000000000000000000000000000000000000000000000000093a8000000000000000000000000000000000000000000000000000000000000007d0
```

**Decoded:**
| Parameter | Type | Value |
|-----------|------|-------|
| `_stakingToken` | address | `0x2ca8b2b97bc0f0ccdd875dcfeff16b868a1b5ba3` (BAItest) |
| `_lockPeriod` | uint256 | `604800` (7 days in seconds) |
| `_earlyUnstakePenaltyBps` | uint256 | `2000` (20% = 2000 basis points) |

---

## Compilation Settings (From Bytecode Analysis)

| Setting | Value |
|---------|-------|
| **Compiler Version** | v0.8.20+commit.a1b79de6 |
| **Optimization** | Yes (enabled) |
| **Runs** | 200 |
| **EVM Version** | Default (shanghai) |
| **License** | MIT |

**Evidence:** Deployed bytecode ends with `64736f6c6343000814` where `0814` = Solidity 0.8.20

---

## The Problem

**The source code we have does NOT match the deployed bytecode.**

### Bytecode Size Comparison
| Source | Creation Code Size | Notes |
|--------|-------------------|-------|
| **Deployed** | `610f1b` (3,867 bytes) | What's on-chain |
| **Our Compile** | `610ef1` (3,825 bytes) | 42 bytes smaller |

### Function Selector Comparison

The deployed contract has these function selectors (from bytecode):
```
028cc262 - earned(address)
16934fc4 - stakes(address)
2bbf532a - isUnlocked(address)
2e17de78 - unstake(uint256)
372500ab - claimRewards()
3fd8b02f - penaltyBps()
4ecce451 - calculatePenalty(uint256)
72f702f3 - stakingToken()
76b467b7 - unlockTime(address)
817b1cd2 - totalStaked()
a694fc3a - stake(uint256)
df136d65 - rewardPerTokenStored()
e9fad8ee - exit()
ecfad9fd - lockPeriod()
```

Our compiled version produces slightly different bytecode offsets, suggesting minor differences in:
- Internal function ordering
- Variable packing
- Or OpenZeppelin library versions

---

## Deployed Bytecode (What BaseScan Wants)

```
60e060405234801561000f575f80fd5b50604051610f1b380380610f1b83398101604081905261002e91610095565b60015f556001600160a01b0383166100595760405163d92e233d60e01b815260040160405180910390fd5b61138881111561007c5760405163458eae5b60e01b815260040160405180910390fd5b6001600160a01b0390921660805260a05260c0526100d4565b5f805f606084860312156100a7575f80fd5b83516001600160a01b03811681146100bd575f80fd5b602085015160409095015190969495509392505050565b60805160a05160c051610dd76101445f395f8181610262015261064301525f81816101a90152818161030d015281816103c9015281816106a1015281816107cb015261087501525f81816101e3015281816104de015281816105ce0152818161077b015261099f0152610dd75ff3fe608060405234801561000f575f80fd5b50600436106100e4575f3560e01c806372f702f311610088578063a694fc3a11610063578063a694fc3a14610239578063df136d651461024c578063e9fad8ee14610255578063ecfad9fd1461025d575f80fd5b806372f702f3146101de57806376b467b71461021d578063817b1cd214610230575f80fd5b80632e17de78116100c35780632e17de7814610187578063372500ab1461019c5780633fd8b02f146101a45780634ecce451146101cb575f80fd5b80628cc262146100e857806316934fc41461010e5780632bbf532a14610164575b5f80fd5b6100fb6100f6366004610ca9565b610284565b6040519081526020015b60405180910390f35b61014461011c366004610ca9565b600360208190525f918252604090912080546001820154600283015492909301549092919084565b604080519485526020850193909352918301526060820152608001610105565b610177610172366004610ca9565b6102e3565b6040519015158152602001610105565b61019a610195366004610ccf565b610345565b005b61019a610554565b6100fb7f000000000000000000000000000000000000000000000000000000000000000081565b6100fb6101d9366004610ccf565b61063a565b6102057f000000000000000000000000000000000000000000000000000000000000000081565b6040516001600160a01b039091168152602001610105565b6100fb61022b366004610ca9565b610678565b6100fb60015481565b61019a610247366004610ccf565b6106cf565b6100fb60025481565b61019a610805565b6100fb7f000000000000000000000000000000000000000000000000000000000000000081565b6001600160a01b0381165f9081526003602081905260408220908101546002808301549054670de0b6b3a7640000916102bc91610cfa565b83546102c89190610d0d565b6102d29190610d24565b6102dc9190610d43565b9392505050565b6001600160a01b0381165f9081526003602052604081208054820361030b5750600192915050565b7f0000000000000000000000000000000000000000000000000000000000000000816001015461033b9190610d43565b4210159392505050565b60025f540361036757604051633ee5aeb560e01b815260040160405180910390fd5b60025f90815581900361038d57604051631f2a200560e01b815260040160405180910390fd5b335f90815260036020526040902080548211156103bd576040516378de4a6960e11b815260040160405180910390fd5b6103c633610a5a565b5f7f000000000000000000000000000000000000000000000000000000000000000082600101546103f79190610d43565b421090505f83821561041b5761040c8561063a565b91506104188286610cfa565b90505b84845f015f82825461042d9190610cfa565b925050819055508460015f8282546104459190610cfa565b9091555050811580159061045a57505f600154115b156104d157600154610474670de0b6b3a764000084610d0d565b61047e9190610d24565b60025f82825461048e9190610d43565b90915550506001546040805184815260208101929092527f2d38dcc2d0e18aa434a8f1b17215fa9a77bfafd48910e87d5d5dbe34c6866984910160405180910390a15b6105056001600160a01b037f0000000000000000000000000000000000000000000000000000000000000000163383610a9e565b604080518681526020810184905284151581830152905133917f6c42d2bb36ad42ac675a97c8627d2cd9e34346d5057bbc3a6ed3c5d1f0a8219b919081900360600190a2505060015f55505050565b60025f540361057657604051633ee5aeb560e01b815260040160405180910390fd5b60025f5561058333610a5a565b335f90815260036020819052604082200154908190036105b6576040516373380d9960e01b815260040160405180910390fd5b335f818152600360208190526040822001556105fd907f00000000000000000000000000000000000000000000000000000000000000006001600160a01b03169083610a9e565b60405181815233907ffc30cddea38e2bf4d6ea7d3f9ed3b6ad7f176419f4963bd81318067a4aee73fe906020015b60405180910390a25060015f55565b5f6127106106687f000000000000000000000000000000000000000000000000000000000000000084610d0d565b6106729190610d24565b92915050565b6001600160a01b0381165f9081526003602052604081208054820361069f57505f92915050565b7f000000000000000000000000000000000000000000000000000000000000000081600101546102dc9190610d43565b60025f54036106f157604051633ee5aeb560e01b815260040160405180910390fd5b60025f90815581900361071757604051631f2a200560e01b815260040160405180910390fd5b61072033610a5a565b335f908152600360205260408120805483929061073e908490610d43565b9091555050335f908152600360205260408120426001918201558054839290610768908490610d43565b909155506107a390506001600160a01b037f000000000000000000000000000000000000000000000000000000000000000016333084610b02565b337f1449c6dd7851abc30abf37f57715f492010519147cc2652fbc38202c18a6ee90826107f07f000000000000000000000000000000000000000000000000000000000000000042610d43565b6040805192835260208301919091520161062b565b60025f540361082757604051633ee5aeb560e01b815260040160405180910390fd5b60025f90815533815260036020526040902080548015801561084b57506003820154155b1561086957604051631f2a200560e01b815260040160405180910390fd5b61087233610a5a565b5f7f000000000000000000000000000000000000000000000000000000000000000083600101546108a39190610d43565b421090505f828280156108b557505f84115b156108d2576108c38461063a565b91506108cf8285610cfa565b90505b6003850180545f8088559182905560018054919287926108f3908490610cfa565b9091555050821580159061090857505f600154115b1561097f57600154610922670de0b6b3a764000085610d0d565b61092c9190610d24565b60025f82825461093c9190610d43565b90915550506001546040805185815260208101929092527f2d38dcc2d0e18aa434a8f1b17215fa9a77bfafd48910e87d5d5dbe34c6866984910160405180910390a15b5f61098a8284610d43565b905080156109c6576109c66001600160a01b037f0000000000000000000000000000000000000000000000000000000000000000163383610a9e565b8515610a1157604080518781526020810186905286151581830152905133917f6c42d2bb36ad42ac675a97c8627d2cd9e34346d5057bbc3a6ed3c5d1f0a8219b919081900360600190a25b8115610a4d5760405182815233907ffc30cddea38e2bf4d6ea7d3f9ed3b6ad7f176419f4963bd81318067a4aee73fe9060200160405180910390a25b505060015f555050505050565b6001600160a01b03811615610a9b57610a7281610284565b6001600160a01b0382165f90815260036020819052604090912090810191909155600280549101555b50565b6040516001600160a01b03838116602483015260448201839052610afd91859182169063a9059cbb906064015b604051602081830303815290604052915060e01b6020820180516001600160e01b038381831617835250505050610b41565b505050565b6040516001600160a01b038481166024830152838116604483015260648201839052610b3b9186918216906323b872dd90608401610acb565b50505050565b5f610b556001600160a01b03841683610ba7565b905080515f14158015610b79575080806020019051810190610b779190610d56565b155b15610afd57604051635274afe760e01b81526001600160a01b03841660048201526024015b60405180910390fd5b60606102dc83835f845f80856001600160a01b03168486604051610bcb9190610d75565b5f6040518083038185875af1925050503d805f8114610c05576040519150601f19603f3d011682016040523d82523d5f602084013e610c0a565b606091505b5091509150610c1a868383610c24565b9695505050505050565b606082610c3957610c3482610c80565b6102dc565b8151158015610c5057506001600160a01b0384163b155b15610c7957604051639996b31560e01b81526001600160a01b0385166004820152602401610b9e565b50806102dc565b805115610c905780518082602001fd5b604051630a12f52160e11b815260040160405180910390fd5b5f60208284031215610cb9575f80fd5b81356001600160a01b03811681146102dc575f80fd5b5f60208284031215610cdf575f80fd5b5035919050565b634e487b7160e01b5f52601160045260245ffd5b8181038181111561067257610672610ce6565b808202811582820484141761067257610672610ce6565b5f82610d3e57634e487b7160e01b5f52601260045260245ffd5b500490565b8082018082111561067257610672610ce6565b5f60208284031215610d66575f80fd5b815180151581146102dc575f80fd5b5f82525f5b81811015610d945760208186018101518583015201610d7a565b505f92019182525091905056fe
```

**Note:** The `{ipfs}` metadata hash at the end varies by compilation and can be ignored for matching.

---

## What We Tried

### Attempt 1: Wrong Compiler Version
- Used v0.8.28 instead of v0.8.20
- **Result:** Failed - bytecode metadata showed 0.8.20

### Attempt 2: Wrong Optimization Settings  
- Used v0.8.20 but optimization disabled
- **Result:** Failed - deployed bytecode is clearly optimized (smaller size)

### Attempt 3: Correct Settings, Wrong Source
- v0.8.20, optimization on, 200 runs
- Used `PenaltyStakingFlat.sol` which was a DIFFERENT contract
- **Result:** Failed - completely different function signatures

### Attempt 4: Reconstructed Flattened File
- Created `PenaltyStakingFlat_v2.sol` from original `PenaltyStaking.sol`
- Manually included OpenZeppelin v5.0.0 dependencies
- **Result:** Failed - bytecode 42 bytes smaller than deployed

---

## Root Cause Analysis

The contract was deployed using **Remix IDE** with specific OpenZeppelin imports. We don't have the exact compilation artifact from that deployment.

Possible causes for mismatch:
1. **OpenZeppelin version differences** - We're using v5.0.0 but deployed might have used slightly different version
2. **Import resolution** - Remix resolves `@openzeppelin/contracts/...` differently than manual flattening
3. **Compiler metadata** - IPFS hash in bytecode varies by source file path/content
4. **Internal ordering** - Solidity compiler may order internal functions differently

---

## Files in Repository

| File | Description |
|------|-------------|
| `/agent/home/bai/contracts/PenaltyStaking.sol` | Original source with OpenZeppelin imports |
| `/agent/home/bai/contracts/PenaltyStakingFlat.sol` | OLD flattened file (WRONG - different contract) |
| `/agent/home/bai/contracts/PenaltyStakingFlat_v2.sol` | NEW flattened file (close but doesn't match) |
| `/agent/home/bai/contracts/deployment.json` | Deployment record |
| `/agent/home/bai/contracts/STAKING-README.md` | Contract documentation |

### GitHub Repository
https://github.com/simpleonbase-commits/BAI-V.0.0.01

---

## Possible Solutions

### Option 1: Decompile and Reconstruct
Use a decompiler (like Dedaub or Panoramix) to reconstruct the exact source from bytecode. Then verify with that.

### Option 2: Find Original Remix Compilation
If the Remix session is still available, export the compilation artifacts which include the exact source and settings.

### Option 3: Bytecode-Level Verification
Some verification services (like Sourcify) do partial matching that's more lenient with metadata differences.

### Option 4: Redeploy with Verified Source
Deploy a new contract with source code we can verify. The current contract works fine - verification is just for transparency.

---

## Contract Functionality (Confirmed Working)

Despite verification issues, the contract IS deployed and functional:

- âœ… Immutable parameters set correctly
- âœ… stakingToken: `0x2ca8b2b97bc0f0ccdd875dcfeff16b868a1b5ba3`
- âœ… lockPeriod: 604800 (7 days)
- âœ… penaltyBps: 2000 (20%)
- âœ… No admin functions (truly immutable)

---

## Contact

**Project:** Bureau of Agent Investigations (BAI)  
**Twitter:** @Simple_on_Base  
**Website:** https://simpleonbase-commits.github.io/BAI-V.0.0.01/

---

*Good luck! ðŸª¨*