<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üíé Diamond Hands Staking - Bureau of Agent Investigations</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: #0a0a0f;
            color: #e0e0e0;
            min-height: 100vh;
            line-height: 1.6;
        }
        .container { max-width: 900px; margin: 0 auto; padding: 20px; }
        header {
            text-align: center;
            padding: 40px 20px;
            border-bottom: 1px solid #1a1a2e;
            margin-bottom: 40px;
        }
        .logo { font-size: 3rem; margin-bottom: 10px; }
        h1 {
            font-size: 2.5rem;
            background: linear-gradient(135deg, #ff6b6b, #ffa500);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
        }
        .tagline { color: #888; font-size: 1.1rem; margin-bottom: 10px; }
        .subtitle { color: #ffa500; font-size: 1.3rem; font-weight: bold; font-style: italic; }
        .connect-section { text-align: center; margin-bottom: 30px; }
        .connect-btn {
            background: linear-gradient(135deg, #ff6b6b, #ffa500);
            color: #000;
            border: none;
            padding: 15px 40px;
            border-radius: 12px;
            font-weight: 700;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s;
        }
        .connect-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 0 30px rgba(255, 107, 107, 0.4);
        }
        .wallet-info {
            background: #12121a;
            border: 1px solid #1a1a2e;
            border-radius: 12px;
            padding: 15px 25px;
            display: inline-flex;
            align-items: center;
            gap: 15px;
            margin-top: 15px;
        }
        .wallet-address { font-family: monospace; color: #4ade80; }
        .disconnect-btn {
            background: #2a2a3e;
            border: none;
            padding: 8px 15px;
            border-radius: 8px;
            color: #ff6b6b;
            font-size: 0.85rem;
            cursor: pointer;
        }
        .disconnect-btn:hover { background: #3a3a4e; }
        /* Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.85);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        .modal-overlay.active { display: flex; }
        .modal {
            background: #12121a;
            border: 1px solid #2a2a3e;
            border-radius: 20px;
            padding: 30px;
            max-width: 400px;
            width: 90%;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }
        .modal-title { font-size: 1.3rem; color: #fff; }
        .modal-close {
            background: none;
            border: none;
            color: #888;
            font-size: 1.5rem;
            cursor: pointer;
        }
        .wallet-option {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 16px 20px;
            background: #1a1a2e;
            border: 1px solid #2a2a3e;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 12px;
        }
        .wallet-option:hover { background: #252535; border-color: #ffa500; }
        .wallet-icon {
            width: 40px; height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            background: linear-gradient(135deg, #f5841f, #e27625);
        }
        .wallet-name { font-weight: 600; color: #fff; }
        .wallet-desc { font-size: 0.8rem; color: #888; }
        /* Stats */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }
        .stat-card {
            background: #12121a;
            border: 1px solid #1a1a2e;
            border-radius: 12px;
            padding: 25px;
            text-align: center;
        }
        .stat-card.highlight {
            border-color: #ffa500;
            background: linear-gradient(135deg, #12121a 0%, #1a1510 100%);
        }
        .stat-label { color: #888; font-size: 0.9rem; text-transform: uppercase; margin-bottom: 8px; }
        .stat-value { font-size: 1.8rem; font-weight: bold; color: #fff; }
        .stat-value.green { color: #4ade80; }
        .stat-value.orange { color: #ffa500; }
        /* Panel */
        .staking-panel {
            background: #12121a;
            border: 1px solid #1a1a2e;
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 30px;
        }
        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid #1a1a2e;
        }
        .panel-title { font-size: 1.5rem; color: #fff; }
        .panel-badge {
            background: linear-gradient(135deg, #ff6b6b, #ffa500);
            color: #000;
            padding: 6px 14px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.85rem;
        }
        /* Tabs */
        .tabs { display: flex; gap: 10px; margin-bottom: 25px; }
        .tab-btn {
            flex: 1;
            padding: 12px 20px;
            background: #1a1a2e;
            border: 1px solid #2a2a3e;
            border-radius: 10px;
            color: #888;
            font-weight: 600;
            cursor: pointer;
        }
        .tab-btn:hover { background: #252535; color: #fff; }
        .tab-btn.active {
            background: linear-gradient(135deg, #ff6b6b, #ffa500);
            color: #000;
            border-color: transparent;
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        /* Input */
        .input-group { margin-bottom: 20px; }
        .input-label { display: flex; justify-content: space-between; margin-bottom: 8px; color: #888; font-size: 0.9rem; }
        .balance-link { color: #ffa500; cursor: pointer; text-decoration: underline; }
        .input-wrapper { position: relative; }
        .amount-input {
            width: 100%;
            background: #0a0a0f;
            border: 1px solid #2a2a3e;
            border-radius: 12px;
            padding: 18px 100px 18px 18px;
            font-size: 1.3rem;
            color: #fff;
            outline: none;
        }
        .amount-input:focus { border-color: #ffa500; }
        .max-btn {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            background: #2a2a3e;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            color: #ffa500;
            font-weight: 600;
            cursor: pointer;
        }
        /* Buttons */
        .action-btn {
            width: 100%;
            padding: 18px;
            border: none;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            margin-top: 10px;
        }
        .action-btn.primary {
            background: linear-gradient(135deg, #ff6b6b, #ffa500);
            color: #000;
        }
        .action-btn.primary:hover {
            transform: scale(1.02);
            box-shadow: 0 0 25px rgba(255, 107, 107, 0.3);
        }
        .action-btn.secondary {
            background: #1a1a2e;
            color: #fff;
            border: 1px solid #2a2a3e;
        }
        .action-btn:disabled {
            background: #333;
            color: #666;
            cursor: not-allowed;
            transform: none;
        }
        /* Warning */
        .warning-box {
            background: linear-gradient(135deg, #2a1a1a 0%, #1a1210 100%);
            border: 1px solid #ff6b6b;
            border-radius: 12px;
            padding: 15px 20px;
            margin-bottom: 20px;
        }
        .warning-box.locked { border-color: #ffa500; background: linear-gradient(135deg, #2a2010 0%, #1a1510 100%); }
        .warning-title { color: #ff6b6b; font-weight: 600; margin-bottom: 5px; }
        .warning-box.locked .warning-title { color: #ffa500; }
        .warning-text { color: #888; font-size: 0.9rem; }
        /* Info Grid */
        .info-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 20px; }
        .info-card { background: #0a0a0f; border: 1px solid #1a1a2e; border-radius: 10px; padding: 15px; }
        .info-label { color: #666; font-size: 0.8rem; text-transform: uppercase; margin-bottom: 5px; }
        .info-value { color: #fff; font-size: 1.1rem; font-weight: 600; }
        /* Rewards */
        .rewards-display {
            text-align: center;
            padding: 30px;
            background: linear-gradient(135deg, #0a150a 0%, #0a0a0f 100%);
            border: 1px solid #2a4a2a;
            border-radius: 12px;
            margin-bottom: 20px;
        }
        .rewards-amount { font-size: 2.5rem; font-weight: bold; color: #4ade80; margin-bottom: 5px; }
        .rewards-label { color: #888; }
        /* Contract Info */
        .contract-info {
            background: #12121a;
            border: 1px solid #1a1a2e;
            border-radius: 12px;
            padding: 20px;
            margin-top: 30px;
        }
        .contract-title { color: #888; font-size: 0.9rem; margin-bottom: 15px; text-transform: uppercase; }
        .contract-links { display: flex; flex-wrap: wrap; gap: 15px; }
        .contract-link {
            color: #ffa500;
            text-decoration: none;
            font-family: monospace;
            font-size: 0.85rem;
            padding: 8px 15px;
            background: #0a0a0f;
            border-radius: 8px;
        }
        footer {
            text-align: center;
            padding: 40px 20px;
            border-top: 1px solid #1a1a2e;
            margin-top: 40px;
            color: #666;
        }
        footer a { color: #ffa500; text-decoration: none; }
        .spinner {
            display: inline-block;
            width: 20px; height: 20px;
            border: 2px solid #333;
            border-top-color: #ffa500;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 8px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .network-warning {
            background: linear-gradient(135deg, #2a1a1a 0%, #1a1210 100%);
            border: 1px solid #ff6b6b;
            border-radius: 12px;
            padding: 15px 20px;
            margin-bottom: 20px;
            text-align: center;
        }
        .network-warning button {
            background: #ff6b6b;
            color: #000;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 10px;
        }
        @media (max-width: 600px) {
            h1 { font-size: 1.8rem; }
            .stats-grid { grid-template-columns: 1fr 1fr; }
            .info-grid { grid-template-columns: 1fr; }
            .tabs { flex-direction: column; }
            .contract-links { flex-direction: column; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">üíé</div>
            <h1>Diamond Hands Staking</h1>
            <p class="tagline">Bureau of Agent Investigations</p>
            <p class="subtitle">"Paper Hands Pay, Diamond Hands Gain"</p>
        </header>

        <div class="connect-section">
            <button class="connect-btn" id="connectBtn" onclick="openModal()">üîó Connect Wallet</button>
            <div class="wallet-info" id="walletInfo" style="display: none;">
                <span>Connected: <span class="wallet-address" id="walletAddress"></span></span>
                <button class="disconnect-btn" onclick="disconnect()">Disconnect</button>
            </div>
        </div>

        <div class="network-warning" id="networkWarning" style="display: none;">
            <div>‚ö†Ô∏è Wrong Network - Please switch to Base</div>
            <button onclick="switchToBase()">Switch to Base</button>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-label">Total Staked</div>
                <div class="stat-value" id="totalStaked">--</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Your Stake</div>
                <div class="stat-value orange" id="yourStake">--</div>
            </div>
            <div class="stat-card highlight">
                <div class="stat-label">Your Rewards</div>
                <div class="stat-value green" id="yourRewards">--</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Lock Status</div>
                <div class="stat-value" id="lockStatus">--</div>
            </div>
        </div>

        <div class="staking-panel">
            <div class="panel-header">
                <h2 class="panel-title">Stake BAItest</h2>
                <span class="panel-badge">20% Early Exit Penalty</span>
            </div>

            <div class="tabs">
                <button class="tab-btn active" onclick="showTab('stake', this)">Stake</button>
                <button class="tab-btn" onclick="showTab('unstake', this)">Unstake</button>
                <button class="tab-btn" onclick="showTab('rewards', this)">Rewards</button>
            </div>

            <div class="tab-content active" id="stakeTab">
                <div class="input-group">
                    <div class="input-label">
                        <span>Amount to Stake</span>
                        <span class="balance-link" onclick="setMaxStake()">Balance: <span id="walletBalance">--</span> BAItest</span>
                    </div>
                    <div class="input-wrapper">
                        <input type="number" class="amount-input" id="stakeAmount" placeholder="0.0" step="any">
                        <button class="max-btn" onclick="setMaxStake()">MAX</button>
                    </div>
                </div>
                <div class="info-grid">
                    <div class="info-card"><div class="info-label">Lock Period</div><div class="info-value">7 Days</div></div>
                    <div class="info-card"><div class="info-label">Early Penalty</div><div class="info-value">20%</div></div>
                </div>
                <button class="action-btn secondary" id="approveBtn" onclick="approveTokens()" style="display: none;">Approve BAItest</button>
                <button class="action-btn primary" id="stakeBtn" onclick="stakeTokens()" disabled>Connect Wallet to Stake</button>
            </div>

            <div class="tab-content" id="unstakeTab">
                <div id="unstakeWarning" class="warning-box locked" style="display: none;">
                    <div class="warning-title">‚è≥ Tokens Locked</div>
                    <div class="warning-text">Your tokens unlock in <span id="unlockCountdown">--</span>. Early unstaking incurs a 20% penalty.</div>
                </div>
                <div id="earlyWarning" class="warning-box" style="display: none;">
                    <div class="warning-title">‚ö†Ô∏è Early Unstake Warning</div>
                    <div class="warning-text">You will lose <span id="penaltyAmount">--</span> BAItest (20%) which goes to remaining stakers.</div>
                </div>
                <div class="input-group">
                    <div class="input-label">
                        <span>Amount to Unstake</span>
                        <span class="balance-link" onclick="setMaxUnstake()">Staked: <span id="stakedBalance">--</span> BAItest</span>
                    </div>
                    <div class="input-wrapper">
                        <input type="number" class="amount-input" id="unstakeAmount" placeholder="0.0" step="any" oninput="updatePenaltyPreview()">
                        <button class="max-btn" onclick="setMaxUnstake()">MAX</button>
                    </div>
                </div>
                <div class="info-grid">
                    <div class="info-card"><div class="info-label">You'll Receive</div><div class="info-value" id="receiveAmount">-- BAItest</div></div>
                    <div class="info-card"><div class="info-label">Penalty</div><div class="info-value" id="penaltyPreview">-- BAItest</div></div>
                </div>
                <button class="action-btn primary" id="unstakeBtn" onclick="unstakeTokens()" disabled>Connect Wallet to Unstake</button>
            </div>

            <div class="tab-content" id="rewardsTab">
                <div class="rewards-display">
                    <div class="rewards-amount" id="claimableRewards">0.00</div>
                    <div class="rewards-label">BAItest Available to Claim</div>
                </div>
                <p style="text-align: center; color: #888; margin-bottom: 20px;">Rewards come from penalties paid by paper hands who unstake early. The longer you stay, the more you earn! üíéüôå</p>
                <button class="action-btn primary" id="claimBtn" onclick="claimRewards()" disabled>Connect Wallet to Claim</button>
                <button class="action-btn secondary" onclick="exitAll()" style="margin-top: 10px;" id="exitBtn" disabled>üö™ Exit All (Unstake + Claim)</button>
            </div>
        </div>

        <div class="contract-info">
            <div class="contract-title">Verified Contracts</div>
            <div class="contract-links">
                <a href="https://basescan.org/address/0x4b5b62Bde4Be0fBab30A74d79c7Cb25FD242c3Cc#code" target="_blank" class="contract-link">üìú Staking: 0x4b5b...c3Cc</a>
                <a href="https://basescan.org/address/0x2ca8b2b97bc0f0ccdd875dcfeff16b868a1b5ba3" target="_blank" class="contract-link">ü™ô BAItest: 0x2ca8...5ba3</a>
            </div>
        </div>

        <footer>
            <p>Part of the <a href="index.html">Bureau of Agent Investigations</a> ecosystem</p>
            <p style="margin-top: 10px; font-size: 0.85rem;">Smart contract is immutable and fully verified. DYOR.</p>
        </footer>
    </div>

    <!-- Modal -->
    <div class="modal-overlay" id="walletModal" onclick="closeModal(event)">
        <div class="modal" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h3 class="modal-title">Connect Wallet</h3>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="wallet-option" onclick="connectWallet()">
                <div class="wallet-icon">ü¶ä</div>
                <div>
                    <div class="wallet-name">MetaMask / Browser Wallet</div>
                    <div class="wallet-desc">Connect using your browser extension</div>
                </div>
            </div>
            <p style="text-align: center; color: #666; font-size: 0.85rem; margin-top: 15px;">Works with MetaMask, Coinbase Wallet, Rainbow, and other injected wallets</p>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.9.0/ethers.umd.min.js"></script>
    <script>
        const STAKING = '0x4b5b62Bde4Be0fBab30A74d79c7Cb25FD242c3Cc';
        const TOKEN = '0x2ca8b2b97bc0f0ccdd875dcfeff16b868a1b5ba3';
        const BASE_ID = 8453;

        const STAKING_ABI = [
            'function stake(uint256 amount) external',
            'function unstake(uint256 amount) external',
            'function claimRewards() external',
            'function exit() external',
            'function totalStaked() view returns (uint256)',
            'function stakes(address) view returns (uint256 amount, uint256 stakedAt, uint256 rewardPerTokenPaid, uint256 pendingRewards)',
            'function earned(address account) view returns (uint256)',
            'function isUnlocked(address account) view returns (bool)',
            'function unlockTime(address account) view returns (uint256)'
        ];

        const ERC20_ABI = [
            'function balanceOf(address) view returns (uint256)',
            'function allowance(address owner, address spender) view returns (uint256)',
            'function approve(address spender, uint256 amount) returns (bool)',
            'function decimals() view returns (uint8)'
        ];

        let provider, signer, addr, staking, token, decimals = 18, staked = 0n, unlocked = true, unlockTime = 0;

        function openModal() { document.getElementById('walletModal').classList.add('active'); }
        function closeModal(e) { if (!e || e.target.id === 'walletModal') document.getElementById('walletModal').classList.remove('active'); }

        async function connectWallet() {
            if (!window.ethereum) { alert('Please install MetaMask or another Web3 wallet'); return; }
            try {
                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                provider = new ethers.BrowserProvider(window.ethereum);
                signer = await provider.getSigner();
                addr = accounts[0];
                
                document.getElementById('connectBtn').style.display = 'none';
                document.getElementById('walletInfo').style.display = 'inline-flex';
                document.getElementById('walletAddress').textContent = addr.slice(0,6) + '...' + addr.slice(-4);
                
                document.getElementById('stakeBtn').disabled = false;
                document.getElementById('stakeBtn').textContent = 'üíé Stake BAItest';
                document.getElementById('unstakeBtn').disabled = false;
                document.getElementById('unstakeBtn').textContent = 'üì§ Unstake';
                document.getElementById('claimBtn').disabled = false;
                document.getElementById('claimBtn').textContent = 'üéÅ Claim Rewards';
                document.getElementById('exitBtn').disabled = false;

                const net = await provider.getNetwork();
                document.getElementById('networkWarning').style.display = Number(net.chainId) !== BASE_ID ? 'block' : 'none';

                staking = new ethers.Contract(STAKING, STAKING_ABI, signer);
                token = new ethers.Contract(TOKEN, ERC20_ABI, signer);
                
                closeModal();
                await refresh();

                window.ethereum.on('accountsChanged', (accs) => {
                    if (accs.length === 0) disconnect();
                    else { addr = accs[0]; document.getElementById('walletAddress').textContent = addr.slice(0,6) + '...' + addr.slice(-4); refresh(); }
                });
                window.ethereum.on('chainChanged', () => window.location.reload());
            } catch (e) { console.error(e); alert('Connection failed: ' + e.message); }
        }

        function disconnect() {
            provider = signer = addr = staking = token = null;
            document.getElementById('connectBtn').style.display = 'block';
            document.getElementById('walletInfo').style.display = 'none';
            document.getElementById('networkWarning').style.display = 'none';
            document.getElementById('stakeBtn').disabled = true;
            document.getElementById('stakeBtn').textContent = 'Connect Wallet to Stake';
            document.getElementById('unstakeBtn').disabled = true;
            document.getElementById('unstakeBtn').textContent = 'Connect Wallet to Unstake';
            document.getElementById('claimBtn').disabled = true;
            document.getElementById('claimBtn').textContent = 'Connect Wallet to Claim';
            document.getElementById('exitBtn').disabled = true;
        }

        async function switchToBase() {
            try {
                await window.ethereum.request({ method: 'wallet_switchEthereumChain', params: [{ chainId: '0x2105' }] });
            } catch (e) {
                if (e.code === 4902) {
                    await window.ethereum.request({
                        method: 'wallet_addEthereumChain',
                        params: [{ chainId: '0x2105', chainName: 'Base', nativeCurrency: { name: 'ETH', symbol: 'ETH', decimals: 18 }, rpcUrls: ['https://mainnet.base.org'], blockExplorerUrls: ['https://basescan.org'] }]
                    });
                }
            }
        }

        function showTab(name, btn) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(name + 'Tab').classList.add('active');
            btn.classList.add('active');
        }

        async function refresh() {
            if (!staking || !token || !addr) return;
            try {
                decimals = Number(await token.decimals());
                const total = await staking.totalStaked();
                document.getElementById('totalStaked').textContent = fmt(total) + ' BAItest';
                const bal = await token.balanceOf(addr);
                document.getElementById('walletBalance').textContent = fmt(bal);
                const info = await staking.stakes(addr);
                staked = info[0];
                document.getElementById('yourStake').textContent = fmt(staked) + ' BAItest';
                document.getElementById('stakedBalance').textContent = fmt(staked);
                const rewards = await staking.earned(addr);
                document.getElementById('yourRewards').textContent = fmt(rewards) + ' BAItest';
                document.getElementById('claimableRewards').textContent = fmt(rewards);
                unlocked = await staking.isUnlocked(addr);
                unlockTime = Number(await staking.unlockTime(addr));
                if (staked == 0n) {
                    document.getElementById('lockStatus').textContent = 'No Stake';
                    document.getElementById('lockStatus').className = 'stat-value';
                    document.getElementById('unstakeWarning').style.display = 'none';
                    document.getElementById('earlyWarning').style.display = 'none';
                } else if (unlocked) {
                    document.getElementById('lockStatus').textContent = '‚úÖ Unlocked';
                    document.getElementById('lockStatus').className = 'stat-value green';
                    document.getElementById('unstakeWarning').style.display = 'none';
                    document.getElementById('earlyWarning').style.display = 'none';
                } else {
                    document.getElementById('lockStatus').textContent = 'üîí Locked';
                    document.getElementById('lockStatus').className = 'stat-value orange';
                    document.getElementById('unstakeWarning').style.display = 'block';
                    document.getElementById('earlyWarning').style.display = 'block';
                    updateCountdown();
                }
                const allowance = await token.allowance(addr, STAKING);
                document.getElementById('approveBtn').style.display = (allowance < bal && bal > 0n) ? 'block' : 'none';
            } catch (e) { console.error('Refresh error:', e); }
        }

        function fmt(amt) {
            const n = parseFloat(ethers.formatUnits(amt, decimals));
            if (n === 0) return '0';
            if (n < 0.01) return '<0.01';
            return n.toLocaleString(undefined, { maximumFractionDigits: 2 });
        }

        function updateCountdown() {
            const rem = unlockTime - Math.floor(Date.now() / 1000);
            if (rem <= 0) { document.getElementById('unlockCountdown').textContent = 'now'; return; }
            const d = Math.floor(rem / 86400), h = Math.floor((rem % 86400) / 3600), m = Math.floor((rem % 3600) / 60);
            document.getElementById('unlockCountdown').textContent = (d > 0 ? d + 'd ' : '') + (h > 0 ? h + 'h ' : '') + m + 'm';
        }

        function updatePenaltyPreview() {
            const amt = parseFloat(document.getElementById('unstakeAmount').value);
            if (!amt || amt <= 0) {
                document.getElementById('penaltyPreview').textContent = '-- BAItest';
                document.getElementById('receiveAmount').textContent = '-- BAItest';
                return;
            }
            if (unlocked) {
                document.getElementById('penaltyPreview').textContent = '0 BAItest';
                document.getElementById('receiveAmount').textContent = amt.toFixed(2) + ' BAItest';
                document.getElementById('penaltyAmount').textContent = '0';
            } else {
                const pen = amt * 0.2;
                document.getElementById('penaltyPreview').textContent = pen.toFixed(2) + ' BAItest';
                document.getElementById('receiveAmount').textContent = (amt - pen).toFixed(2) + ' BAItest';
                document.getElementById('penaltyAmount').textContent = pen.toFixed(2);
            }
        }

        async function setMaxStake() {
            if (!token || !addr) return;
            const bal = await token.balanceOf(addr);
            document.getElementById('stakeAmount').value = ethers.formatUnits(bal, decimals);
        }

        function setMaxUnstake() {
            document.getElementById('unstakeAmount').value = ethers.formatUnits(staked, decimals);
            updatePenaltyPreview();
        }

        async function approveTokens() {
            const btn = document.getElementById('approveBtn');
            try {
                btn.innerHTML = '<span class="spinner"></span>Approving...';
                btn.disabled = true;
                const tx = await token.approve(STAKING, ethers.MaxUint256);
                await tx.wait();
                btn.style.display = 'none';
                alert('‚úÖ Approved!');
                await refresh();
            } catch (e) {
                alert('Approval failed: ' + (e.reason || e.message));
                btn.innerHTML = 'Approve BAItest';
                btn.disabled = false;
            }
        }

        async function stakeTokens() {
            const amt = document.getElementById('stakeAmount').value;
            if (!amt || parseFloat(amt) <= 0) { alert('Enter an amount'); return; }
            const btn = document.getElementById('stakeBtn');
            try {
                btn.innerHTML = '<span class="spinner"></span>Staking...';
                btn.disabled = true;
                const tx = await staking.stake(ethers.parseUnits(amt, decimals));
                await tx.wait();
                alert('‚úÖ Staked ' + amt + ' BAItest! Locked for 7 days.');
                document.getElementById('stakeAmount').value = '';
                await refresh();
            } catch (e) {
                alert('Staking failed: ' + (e.reason || e.message));
            } finally {
                btn.innerHTML = 'üíé Stake BAItest';
                btn.disabled = false;
            }
        }

        async function unstakeTokens() {
            const amt = document.getElementById('unstakeAmount').value;
            if (!amt || parseFloat(amt) <= 0) { alert('Enter an amount'); return; }
            if (!unlocked && !confirm('‚ö†Ô∏è Early unstake! You will lose ' + (parseFloat(amt) * 0.2).toFixed(2) + ' BAItest (20%). Proceed?')) return;
            const btn = document.getElementById('unstakeBtn');
            try {
                btn.innerHTML = '<span class="spinner"></span>Unstaking...';
                btn.disabled = true;
                const tx = await staking.unstake(ethers.parseUnits(amt, decimals));
                await tx.wait();
                alert('‚úÖ Unstaked!');
                document.getElementById('unstakeAmount').value = '';
                await refresh();
            } catch (e) {
                alert('Unstaking failed: ' + (e.reason || e.message));
            } finally {
                btn.innerHTML = 'üì§ Unstake';
                btn.disabled = false;
            }
        }

        async function claimRewards() {
            const btn = document.getElementById('claimBtn');
            try {
                btn.innerHTML = '<span class="spinner"></span>Claiming...';
                btn.disabled = true;
                const tx = await staking.claimRewards();
                await tx.wait();
                alert('‚úÖ Rewards claimed!');
                await refresh();
            } catch (e) {
                alert('Claim failed: ' + (e.reason || e.message));
            } finally {
                btn.innerHTML = 'üéÅ Claim Rewards';
                btn.disabled = false;
            }
        }

        async function exitAll() {
            if (!unlocked && staked > 0n) {
                const pen = fmt(staked * 20n / 100n);
                if (!confirm('‚ö†Ô∏è Early exit! You will lose ~' + pen + ' BAItest (20%). Proceed?')) return;
            }
            const btn = document.getElementById('exitBtn');
            try {
                btn.innerHTML = '<span class="spinner"></span>Exiting...';
                btn.disabled = true;
                const tx = await staking.exit();
                await tx.wait();
                alert('‚úÖ Exited!');
                await refresh();
            } catch (e) {
                alert('Exit failed: ' + (e.reason || e.message));
            } finally {
                btn.innerHTML = 'üö™ Exit All (Unstake + Claim)';
                btn.disabled = false;
            }
        }

        setInterval(updateCountdown, 60000);
    </script>
</body>
</html>