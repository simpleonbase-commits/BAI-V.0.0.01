<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BAI Staking - Paper Hands Pay, Diamond Hands Gain</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-dark: #0a0a0f;
            --bg-card: #12121a;
            --bg-card-hover: #1a1a25;
            --accent-blue: #3b82f6;
            --accent-purple: #8b5cf6;
            --accent-green: #10b981;
            --accent-red: #ef4444;
            --accent-gold: #f59e0b;
            --text-primary: #ffffff;
            --text-secondary: #9ca3af;
            --border-color: #2a2a3a;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Space Grotesk', sans-serif;
            background: var(--bg-dark);
            color: var(--text-primary);
            min-height: 100vh;
            background-image: 
                radial-gradient(ellipse at top, rgba(59, 130, 246, 0.1) 0%, transparent 50%),
                radial-gradient(ellipse at bottom, rgba(139, 92, 246, 0.1) 0%, transparent 50%);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 3rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .logo-icon {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .logo-text {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .logo-text span {
            color: var(--accent-blue);
        }

        .connect-btn {
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
            border: none;
            padding: 0.875rem 1.75rem;
            border-radius: 12px;
            color: white;
            font-family: inherit;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .connect-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 40px rgba(59, 130, 246, 0.3);
        }

        .connect-btn.connected {
            background: var(--bg-card);
            border: 1px solid var(--accent-green);
        }

        /* Hero */
        .hero {
            text-align: center;
            margin-bottom: 3rem;
        }

        .hero h1 {
            font-size: 3rem;
            margin-bottom: 1rem;
            background: linear-gradient(135deg, #fff, var(--accent-blue));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .hero .tagline {
            font-size: 1.5rem;
            color: var(--accent-gold);
            margin-bottom: 0.5rem;
        }

        .hero .subtitle {
            color: var(--text-secondary);
            font-size: 1.1rem;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 3rem;
        }

        .stat-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 1.5rem;
            text-align: center;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            border-color: var(--accent-blue);
            transform: translateY(-2px);
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 0.875rem;
            margin-bottom: 0.5rem;
        }

        .stat-value {
            font-size: 1.75rem;
            font-weight: 700;
        }

        .stat-value.green { color: var(--accent-green); }
        .stat-value.gold { color: var(--accent-gold); }
        .stat-value.blue { color: var(--accent-blue); }
        .stat-value.red { color: var(--accent-red); }

        /* Main Panel */
        .main-panel {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
        }

        @media (max-width: 768px) {
            .main-panel {
                grid-template-columns: 1fr;
            }
            .hero h1 {
                font-size: 2rem;
            }
        }

        .panel {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            padding: 2rem;
        }

        .panel-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            background: var(--bg-dark);
            padding: 0.25rem;
            border-radius: 12px;
        }

        .tab {
            flex: 1;
            padding: 0.75rem;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            font-family: inherit;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            border-radius: 10px;
            transition: all 0.3s ease;
        }

        .tab.active {
            background: var(--accent-blue);
            color: white;
        }

        .tab:hover:not(.active) {
            color: var(--text-primary);
        }

        /* Input Group */
        .input-group {
            margin-bottom: 1.5rem;
        }

        .input-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        .input-wrapper {
            position: relative;
        }

        .input-wrapper input {
            width: 100%;
            padding: 1rem;
            padding-right: 5rem;
            background: var(--bg-dark);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 1.1rem;
            outline: none;
            transition: border-color 0.3s ease;
        }

        .input-wrapper input:focus {
            border-color: var(--accent-blue);
        }

        .max-btn {
            position: absolute;
            right: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(59, 130, 246, 0.2);
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            color: var(--accent-blue);
            font-family: inherit;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .max-btn:hover {
            background: rgba(59, 130, 246, 0.3);
        }

        /* Action Button */
        .action-btn {
            width: 100%;
            padding: 1rem;
            border: none;
            border-radius: 12px;
            font-family: inherit;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .action-btn.primary {
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
            color: white;
        }

        .action-btn.primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 40px rgba(59, 130, 246, 0.3);
        }

        .action-btn.danger {
            background: linear-gradient(135deg, var(--accent-red), #dc2626);
            color: white;
        }

        .action-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* Warning Box */
        .warning-box {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
        }

        .warning-box.hidden {
            display: none;
        }

        .warning-icon {
            font-size: 1.25rem;
        }

        .warning-text {
            font-size: 0.9rem;
            color: var(--accent-red);
        }

        /* Info Box */
        .info-box {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1.5rem;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }

        .info-row:last-child {
            margin-bottom: 0;
        }

        .info-label {
            color: var(--text-secondary);
        }

        .info-value {
            font-weight: 600;
        }

        /* Position Card */
        .position-card {
            background: var(--bg-dark);
            border-radius: 12px;
            padding: 1.25rem;
            margin-bottom: 1rem;
        }

        .position-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .position-amount {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .position-status {
            padding: 0.375rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .position-status.locked {
            background: rgba(239, 68, 68, 0.2);
            color: var(--accent-red);
        }

        .position-status.unlocked {
            background: rgba(16, 185, 129, 0.2);
            color: var(--accent-green);
        }

        .position-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .position-detail {
            text-align: center;
        }

        .position-detail-label {
            color: var(--text-secondary);
            font-size: 0.75rem;
            margin-bottom: 0.25rem;
        }

        .position-detail-value {
            font-weight: 600;
        }

        /* Token Info */
        .token-info {
            text-align: center;
            padding: 1rem;
            background: var(--bg-dark);
            border-radius: 12px;
            margin-top: 1rem;
        }

        .token-info-label {
            color: var(--text-secondary);
            font-size: 0.75rem;
            margin-bottom: 0.25rem;
        }

        .token-address {
            font-family: monospace;
            font-size: 0.8rem;
            color: var(--accent-blue);
            word-break: break-all;
        }

        /* Footer */
        .footer {
            text-align: center;
            margin-top: 3rem;
            padding-top: 2rem;
            border-top: 1px solid var(--border-color);
            color: var(--text-secondary);
        }

        .footer a {
            color: var(--accent-blue);
            text-decoration: none;
        }

        .footer a:hover {
            text-decoration: underline;
        }

        /* Wallet Modal Styles */
        .wallet-modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .wallet-modal-overlay.show {
            display: flex;
        }

        .wallet-modal {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            padding: 2rem;
            max-width: 400px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .wallet-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .wallet-modal-title {
            font-size: 1.25rem;
            font-weight: 600;
        }

        .wallet-modal-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0.25rem;
            line-height: 1;
        }

        .wallet-modal-close:hover {
            color: var(--text-primary);
        }

        .wallet-option {
            display: flex;
            align-items: center;
            gap: 1rem;
            width: 100%;
            padding: 1rem;
            background: var(--bg-dark);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            margin-bottom: 0.75rem;
            cursor: pointer;
            transition: all 0.3s ease;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 1rem;
        }

        .wallet-option:hover {
            border-color: var(--accent-blue);
            background: var(--bg-card-hover);
        }

        .wallet-option img {
            width: 40px;
            height: 40px;
            border-radius: 10px;
        }

        .wallet-option-info {
            text-align: left;
        }

        .wallet-option-name {
            font-weight: 600;
        }

        .wallet-option-desc {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .wallet-divider {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin: 1.5rem 0;
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        .wallet-divider::before,
        .wallet-divider::after {
            content: '';
            flex: 1;
            height: 1px;
            background: var(--border-color);
        }

        .qr-container {
            text-align: center;
            padding: 1.5rem;
            background: white;
            border-radius: 12px;
            margin-bottom: 1rem;
        }

        .qr-container canvas {
            max-width: 200px;
        }

        .wallet-copy-link {
            display: block;
            text-align: center;
            color: var(--accent-blue);
            font-size: 0.875rem;
            cursor: pointer;
            margin-top: 0.5rem;
        }

        .wallet-copy-link:hover {
            text-decoration: underline;
        }

        /* Loading spinner */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <div class="logo">
                <div class="logo-icon">üíé</div>
                <div class="logo-text">BAI <span>Staking</span></div>
            </div>
            <button class="connect-btn" id="connectBtn" onclick="openWalletModal()">Connect Wallet</button>
        </header>

        <!-- Hero -->
        <section class="hero">
            <h1>üíé Paper Hands Pay, Diamond Hands Gain üíé</h1>
            <p class="tagline">Stake BAItest ‚Ä¢ Earn from early exits</p>
            <p class="subtitle">Lock for 7 days or pay 20% to those who wait</p>
        </section>

        <!-- Stats -->
        <section class="stats-grid">
            <div class="stat-card">
                <div class="stat-label">Total Value Locked</div>
                <div class="stat-value blue" id="tvl">0 BAItest</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Lock Period</div>
                <div class="stat-value gold">7 Days</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Early Exit Penalty</div>
                <div class="stat-value red">20%</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Your Rewards</div>
                <div class="stat-value green" id="rewards">0 BAItest</div>
            </div>
        </section>

        <!-- Main Panel -->
        <section class="main-panel">
            <!-- Left: Stake/Unstake -->
            <div class="panel">
                <div class="tabs">
                    <button class="tab active" onclick="switchTab('stake')">Stake</button>
                    <button class="tab" onclick="switchTab('unstake')">Unstake</button>
                    <button class="tab" onclick="switchTab('claim')">Claim</button>
                </div>

                <!-- Stake Tab -->
                <div id="stakeTab">
                    <div class="input-group">
                        <div class="input-label">
                            <span>Amount to Stake</span>
                            <span>Balance: <span id="walletBalance">0</span> BAItest</span>
                        </div>
                        <div class="input-wrapper">
                            <input type="number" id="stakeAmount" placeholder="0.0">
                            <button class="max-btn" onclick="setMaxStake()">MAX</button>
                        </div>
                    </div>
                    <div class="info-box">
                        <div class="info-row">
                            <span class="info-label">Lock Period</span>
                            <span class="info-value">7 days</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Early Exit Penalty</span>
                            <span class="info-value">20%</span>
                        </div>
                    </div>
                    <button class="action-btn primary" id="stakeBtn" onclick="stake()">Stake BAItest</button>
                </div>

                <!-- Unstake Tab -->
                <div id="unstakeTab" style="display: none;">
                    <div class="warning-box" id="penaltyWarning">
                        <span class="warning-icon">‚ö†Ô∏è</span>
                        <span class="warning-text">Your stake is still locked! Unstaking now will cost you <strong>20%</strong> penalty.</span>
                    </div>
                    <div class="input-group">
                        <div class="input-label">
                            <span>Amount to Unstake</span>
                            <span>Staked: <span id="stakedBalance">0</span> BAItest</span>
                        </div>
                        <div class="input-wrapper">
                            <input type="number" id="unstakeAmount" placeholder="0.0">
                            <button class="max-btn" onclick="setMaxUnstake()">MAX</button>
                        </div>
                    </div>
                    <div class="info-box">
                        <div class="info-row">
                            <span class="info-label">You Will Receive</span>
                            <span class="info-value" id="receiveAmount">0 BAItest</span>
                        </div>
                        <div class="info-row" id="penaltyRow">
                            <span class="info-label">Penalty (20%)</span>
                            <span class="info-value" style="color: var(--accent-red)" id="penaltyAmount">0 BAItest</span>
                        </div>
                    </div>
                    <button class="action-btn danger" id="unstakeBtn" onclick="unstake()">Unstake BAItest</button>
                </div>

                <!-- Claim Tab -->
                <div id="claimTab" style="display: none;">
                    <div class="info-box">
                        <div class="info-row">
                            <span class="info-label">Claimable Rewards</span>
                            <span class="info-value" style="color: var(--accent-green)" id="claimableRewards">0 BAItest</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Source</span>
                            <span class="info-value">Paper hands penalties üßª</span>
                        </div>
                    </div>
                    <button class="action-btn primary" id="claimBtn" onclick="claimRewards()">Claim Rewards üí∞</button>
                </div>

                <div class="token-info">
                    <div class="token-info-label">BAItest Token Contract</div>
                    <div class="token-address">0x2ca8b2b97bc0f0ccdd875dcfeff16b868a1b5ba3</div>
                </div>
            </div>

            <!-- Right: Your Position -->
            <div class="panel">
                <h3 class="panel-title">üìä Your Position</h3>
                
                <div class="position-card">
                    <div class="position-header">
                        <span class="position-amount" id="yourStake">0 BAItest</span>
                        <span class="position-status locked" id="lockStatus">üîí Locked</span>
                    </div>
                    <div class="position-details">
                        <div class="position-detail">
                            <div class="position-detail-label">Unlock Time</div>
                            <div class="position-detail-value" id="unlockTime">--</div>
                        </div>
                        <div class="position-detail">
                            <div class="position-detail-label">Time Remaining</div>
                            <div class="position-detail-value" id="timeRemaining">--</div>
                        </div>
                    </div>
                </div>

                <div class="info-box">
                    <div class="info-row">
                        <span class="info-label">Pending Rewards</span>
                        <span class="info-value" style="color: var(--accent-green)" id="pendingRewards">0 BAItest</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Share of Pool</span>
                        <span class="info-value" id="poolShare">0%</span>
                    </div>
                </div>

                <button class="action-btn primary" onclick="exitAll()" id="exitBtn">Exit All (Unstake + Claim)</button>

                <div class="token-info">
                    <div class="token-info-label">Staking Contract</div>
                    <div class="token-address">0x4b5b62Bde4Be0fBab30A74d79c7Cb25FD242c3Cc</div>
                </div>
            </div>
        </section>

        <!-- Footer -->
        <footer class="footer">
            <p>Part of the <a href="index.html">Bureau of Agent Investigations</a></p>
            <p style="margin-top: 0.5rem">Contract verified on <a href="https://basescan.org/address/0x4b5b62Bde4Be0fBab30A74d79c7Cb25FD242c3Cc#code" target="_blank">BaseScan</a> & <a href="https://repo.sourcify.dev/contracts/full_match/8453/0x4b5b62Bde4Be0fBab30A74d79c7Cb25FD242c3Cc/" target="_blank">Sourcify</a></p>
        </footer>
    </div>

    <!-- Wallet Modal -->
    <div class="wallet-modal-overlay" id="walletModal">
        <div class="wallet-modal">
            <div class="wallet-modal-header">
                <span class="wallet-modal-title">Connect Wallet</span>
                <button class="wallet-modal-close" onclick="closeWalletModal()">&times;</button>
            </div>
            
            <button class="wallet-option" onclick="connectMetaMask()">
                <img src="https://upload.wikimedia.org/wikipedia/commons/3/36/MetaMask_Fox.svg" alt="MetaMask">
                <div class="wallet-option-info">
                    <div class="wallet-option-name">MetaMask</div>
                    <div class="wallet-option-desc">Connect using browser extension</div>
                </div>
            </button>

            <button class="wallet-option" onclick="connectCoinbase()">
                <img src="https://altcoinsbox.com/wp-content/uploads/2022/12/coinbase-wallet-logo.png" alt="Coinbase">
                <div class="wallet-option-info">
                    <div class="wallet-option-name">Coinbase Wallet</div>
                    <div class="wallet-option-desc">Connect using Coinbase Wallet</div>
                </div>
            </button>

            <div class="wallet-divider">or scan with mobile</div>

            <div id="wcLoading" style="text-align: center; padding: 2rem; display: none;">
                <div class="loading"></div>
                <p style="margin-top: 1rem; color: var(--text-secondary);">Generating QR code...</p>
            </div>

            <div id="wcQrContainer" style="display: none;">
                <div class="qr-container">
                    <canvas id="wcQrCode"></canvas>
                </div>
                <p style="text-align: center; color: var(--text-secondary); font-size: 0.875rem;">Scan with any WalletConnect-compatible wallet</p>
                <span class="wallet-copy-link" onclick="copyWcUri()">Copy connection link</span>
            </div>

            <button class="wallet-option" onclick="showWalletConnectQR()" id="wcButton">
                <img src="https://seeklogo.com/images/W/walletconnect-logo-EE83B50C97-seeklogo.com.png" alt="WalletConnect">
                <div class="wallet-option-info">
                    <div class="wallet-option-name">WalletConnect</div>
                    <div class="wallet-option-desc">Scan QR with mobile wallet</div>
                </div>
            </button>
        </div>
    </div>

    <!-- QR Code Library -->
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    
    <!-- WalletConnect packages -->
    <script type="module">
        import { Core } from 'https://esm.sh/@walletconnect/core@2.11.0';
        import { Web3Wallet } from 'https://esm.sh/@walletconnect/web3wallet@1.10.0';
        import SignClient from 'https://esm.sh/@walletconnect/sign-client@2.11.0';
        
        // WalletConnect setup
        const projectId = '286e939deb1fd152d44312f068de95da';
        let signClient = null;
        let wcUri = null;
        
        async function initWalletConnect() {
            try {
                signClient = await SignClient.init({
                    projectId: projectId,
                    metadata: {
                        name: 'BAI Staking',
                        description: 'Paper Hands Pay, Diamond Hands Gain',
                        url: 'https://simpleonbase-commits.github.io/BAI-V.0.0.01/',
                        icons: ['https://simpleonbase-commits.github.io/BAI-V.0.0.01/favicon.ico']
                    }
                });
                
                signClient.on('session_event', ({ event }) => {
                    console.log('Session event:', event);
                });
                
                signClient.on('session_update', ({ topic, params }) => {
                    console.log('Session update:', params);
                });
                
                signClient.on('session_delete', () => {
                    console.log('Session deleted');
                    window.currentAccount = null;
                    updateUI();
                });
                
                console.log('WalletConnect initialized');
            } catch (e) {
                console.error('WalletConnect init error:', e);
            }
        }
        
        window.showWalletConnectQR = async function() {
            const wcButton = document.getElementById('wcButton');
            const wcLoading = document.getElementById('wcLoading');
            const wcQrContainer = document.getElementById('wcQrContainer');
            
            wcButton.style.display = 'none';
            wcLoading.style.display = 'block';
            
            try {
                if (!signClient) {
                    await initWalletConnect();
                }
                
                const { uri, approval } = await signClient.connect({
                    requiredNamespaces: {
                        eip155: {
                            methods: ['eth_sendTransaction', 'personal_sign', 'eth_signTypedData'],
                            chains: ['eip155:8453'],
                            events: ['chainChanged', 'accountsChanged']
                        }
                    }
                });
                
                wcUri = uri;
                
                // Generate QR code
                wcLoading.style.display = 'none';
                wcQrContainer.style.display = 'block';
                
                const canvas = document.getElementById('wcQrCode');
                await QRCode.toCanvas(canvas, uri, {
                    width: 200,
                    margin: 2,
                    color: {
                        dark: '#000000',
                        light: '#ffffff'
                    }
                });
                
                // Wait for approval
                const session = await approval();
                const accounts = session.namespaces.eip155.accounts;
                const address = accounts[0].split(':')[2];
                
                window.currentAccount = address;
                window.wcSession = session;
                closeWalletModal();
                await updateUI();
                
            } catch (e) {
                console.error('WalletConnect error:', e);
                wcLoading.style.display = 'none';
                wcButton.style.display = 'flex';
                if (e.message !== 'User rejected') {
                    alert('Connection failed: ' + e.message);
                }
            }
        };
        
        window.copyWcUri = function() {
            if (wcUri) {
                navigator.clipboard.writeText(wcUri);
                alert('Connection link copied!');
            }
        };
        
        // Initialize on load
        initWalletConnect();
    </script>

    <script>
        // Contract addresses
        const STAKING_CONTRACT = '0x4b5b62Bde4Be0fBab30A74d79c7Cb25FD242c3Cc';
        const TOKEN_CONTRACT = '0x2ca8b2b97bc0f0ccdd875dcfeff16b868a1b5ba3';
        const BASE_CHAIN_ID = '0x2105'; // 8453 in hex
        
        // Contract ABIs (minimal)
        const STAKING_ABI = [
            'function stake(uint256 amount) external',
            'function unstake(uint256 amount) external',
            'function claimRewards() external',
            'function exit() external',
            'function stakes(address) view returns (uint256 amount, uint256 stakedAt, uint256 rewardPerTokenPaid, uint256 pendingRewards)',
            'function earned(address account) view returns (uint256)',
            'function isUnlocked(address account) view returns (bool)',
            'function unlockTime(address account) view returns (uint256)',
            'function totalStaked() view returns (uint256)',
            'function calculatePenalty(uint256 amount) view returns (uint256)'
        ];
        
        const TOKEN_ABI = [
            'function balanceOf(address) view returns (uint256)',
            'function approve(address spender, uint256 amount) returns (bool)',
            'function allowance(address owner, address spender) view returns (uint256)',
            'function decimals() view returns (uint8)'
        ];

        // State
        let currentAccount = null;
        let provider = null;
        let signer = null;
        let stakingContract = null;
        let tokenContract = null;
        let tokenDecimals = 18;

        // Wallet Modal Functions
        function openWalletModal() {
            if (currentAccount) {
                // Already connected - disconnect
                disconnectWallet();
                return;
            }
            document.getElementById('walletModal').classList.add('show');
            // Reset WalletConnect UI
            document.getElementById('wcButton').style.display = 'flex';
            document.getElementById('wcLoading').style.display = 'none';
            document.getElementById('wcQrContainer').style.display = 'none';
        }

        function closeWalletModal() {
            document.getElementById('walletModal').classList.remove('show');
        }

        // Click outside to close
        document.getElementById('walletModal').addEventListener('click', function(e) {
            if (e.target === this) closeWalletModal();
        });

        async function connectMetaMask() {
            if (typeof window.ethereum === 'undefined') {
                alert('MetaMask is not installed. Please install it from metamask.io');
                return;
            }
            
            try {
                // Request accounts
                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                
                // Check/switch to Base network
                try {
                    await window.ethereum.request({
                        method: 'wallet_switchEthereumChain',
                        params: [{ chainId: BASE_CHAIN_ID }],
                    });
                } catch (switchError) {
                    if (switchError.code === 4902) {
                        await window.ethereum.request({
                            method: 'wallet_addEthereumChain',
                            params: [{
                                chainId: BASE_CHAIN_ID,
                                chainName: 'Base',
                                nativeCurrency: { name: 'ETH', symbol: 'ETH', decimals: 18 },
                                rpcUrls: ['https://mainnet.base.org'],
                                blockExplorerUrls: ['https://basescan.org']
                            }],
                        });
                    }
                }
                
                currentAccount = accounts[0];
                closeWalletModal();
                await initContracts();
                await updateUI();
                
            } catch (error) {
                console.error('MetaMask connection error:', error);
                alert('Failed to connect: ' + error.message);
            }
        }

        async function connectCoinbase() {
            // Coinbase Wallet also injects ethereum provider
            if (typeof window.ethereum === 'undefined') {
                alert('No wallet detected. Please install Coinbase Wallet.');
                return;
            }
            // Use same flow as MetaMask
            await connectMetaMask();
        }

        function disconnectWallet() {
            currentAccount = null;
            provider = null;
            signer = null;
            stakingContract = null;
            tokenContract = null;
            updateUI();
        }

        async function initContracts() {
            if (!window.ethereum || !currentAccount) return;
            
            // Use ethers from CDN
            provider = new ethers.BrowserProvider(window.ethereum);
            signer = await provider.getSigner();
            
            stakingContract = new ethers.Contract(STAKING_CONTRACT, STAKING_ABI, signer);
            tokenContract = new ethers.Contract(TOKEN_CONTRACT, TOKEN_ABI, signer);
            
            try {
                tokenDecimals = await tokenContract.decimals();
            } catch {
                tokenDecimals = 18;
            }
        }

        async function updateUI() {
            const connectBtn = document.getElementById('connectBtn');
            
            if (!currentAccount) {
                connectBtn.textContent = 'Connect Wallet';
                connectBtn.classList.remove('connected');
                document.getElementById('walletBalance').textContent = '0';
                document.getElementById('stakedBalance').textContent = '0';
                document.getElementById('yourStake').textContent = '0 BAItest';
                document.getElementById('rewards').textContent = '0 BAItest';
                document.getElementById('pendingRewards').textContent = '0 BAItest';
                document.getElementById('claimableRewards').textContent = '0 BAItest';
                document.getElementById('lockStatus').textContent = 'üîí Locked';
                document.getElementById('lockStatus').className = 'position-status locked';
                document.getElementById('unlockTime').textContent = '--';
                document.getElementById('timeRemaining').textContent = '--';
                document.getElementById('poolShare').textContent = '0%';
                return;
            }
            
            // Update button
            const shortAddr = currentAccount.slice(0, 6) + '...' + currentAccount.slice(-4);
            connectBtn.textContent = shortAddr + ' ‚úì';
            connectBtn.classList.add('connected');
            
            if (!stakingContract) {
                await initContracts();
            }
            
            try {
                // Get balances
                const tokenBalance = await tokenContract.balanceOf(currentAccount);
                const formattedBalance = ethers.formatUnits(tokenBalance, tokenDecimals);
                document.getElementById('walletBalance').textContent = parseFloat(formattedBalance).toFixed(2);
                
                // Get stake info
                const stakeInfo = await stakingContract.stakes(currentAccount);
                const stakedAmount = ethers.formatUnits(stakeInfo.amount, tokenDecimals);
                document.getElementById('stakedBalance').textContent = parseFloat(stakedAmount).toFixed(2);
                document.getElementById('yourStake').textContent = parseFloat(stakedAmount).toFixed(2) + ' BAItest';
                
                // Get rewards
                const earned = await stakingContract.earned(currentAccount);
                const earnedFormatted = ethers.formatUnits(earned, tokenDecimals);
                document.getElementById('rewards').textContent = parseFloat(earnedFormatted).toFixed(4) + ' BAItest';
                document.getElementById('pendingRewards').textContent = parseFloat(earnedFormatted).toFixed(4) + ' BAItest';
                document.getElementById('claimableRewards').textContent = parseFloat(earnedFormatted).toFixed(4) + ' BAItest';
                
                // Get TVL
                const totalStaked = await stakingContract.totalStaked();
                const tvlFormatted = ethers.formatUnits(totalStaked, tokenDecimals);
                document.getElementById('tvl').textContent = parseFloat(tvlFormatted).toFixed(2) + ' BAItest';
                
                // Calculate pool share
                if (parseFloat(tvlFormatted) > 0) {
                    const share = (parseFloat(stakedAmount) / parseFloat(tvlFormatted) * 100).toFixed(2);
                    document.getElementById('poolShare').textContent = share + '%';
                } else {
                    document.getElementById('poolShare').textContent = '0%';
                }
                
                // Get lock status
                const isUnlocked = await stakingContract.isUnlocked(currentAccount);
                const unlockTimestamp = await stakingContract.unlockTime(currentAccount);
                
                if (parseFloat(stakedAmount) === 0) {
                    document.getElementById('lockStatus').textContent = 'No Stake';
                    document.getElementById('lockStatus').className = 'position-status';
                    document.getElementById('unlockTime').textContent = '--';
                    document.getElementById('timeRemaining').textContent = '--';
                    document.getElementById('penaltyWarning').classList.add('hidden');
                } else if (isUnlocked) {
                    document.getElementById('lockStatus').textContent = 'üîì Unlocked';
                    document.getElementById('lockStatus').className = 'position-status unlocked';
                    document.getElementById('unlockTime').textContent = 'Now';
                    document.getElementById('timeRemaining').textContent = 'Ready!';
                    document.getElementById('penaltyWarning').classList.add('hidden');
                } else {
                    document.getElementById('lockStatus').textContent = 'üîí Locked';
                    document.getElementById('lockStatus').className = 'position-status locked';
                    const unlockDate = new Date(Number(unlockTimestamp) * 1000);
                    document.getElementById('unlockTime').textContent = unlockDate.toLocaleDateString();
                    
                    const remaining = Number(unlockTimestamp) - Math.floor(Date.now() / 1000);
                    const days = Math.floor(remaining / 86400);
                    const hours = Math.floor((remaining % 86400) / 3600);
                    document.getElementById('timeRemaining').textContent = days + 'd ' + hours + 'h';
                    document.getElementById('penaltyWarning').classList.remove('hidden');
                }
                
            } catch (error) {
                console.error('Error updating UI:', error);
            }
        }

        // Tab switching
        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab')[['stake', 'unstake', 'claim'].indexOf(tab)].classList.add('active');
            
            document.getElementById('stakeTab').style.display = tab === 'stake' ? 'block' : 'none';
            document.getElementById('unstakeTab').style.display = tab === 'unstake' ? 'block' : 'none';
            document.getElementById('claimTab').style.display = tab === 'claim' ? 'block' : 'none';
        }

        // Max buttons
        function setMaxStake() {
            const balance = document.getElementById('walletBalance').textContent;
            document.getElementById('stakeAmount').value = balance;
        }

        function setMaxUnstake() {
            const staked = document.getElementById('stakedBalance').textContent;
            document.getElementById('unstakeAmount').value = staked;
            updateUnstakePreview();
        }

        // Update unstake preview
        document.getElementById('unstakeAmount').addEventListener('input', updateUnstakePreview);
        
        async function updateUnstakePreview() {
            const amount = document.getElementById('unstakeAmount').value || 0;
            const isUnlocked = document.getElementById('lockStatus').textContent.includes('Unlocked');
            
            if (isUnlocked) {
                document.getElementById('receiveAmount').textContent = parseFloat(amount).toFixed(4) + ' BAItest';
                document.getElementById('penaltyAmount').textContent = '0 BAItest';
                document.getElementById('penaltyRow').style.display = 'none';
            } else {
                const penalty = parseFloat(amount) * 0.20;
                const receive = parseFloat(amount) - penalty;
                document.getElementById('receiveAmount').textContent = receive.toFixed(4) + ' BAItest';
                document.getElementById('penaltyAmount').textContent = penalty.toFixed(4) + ' BAItest';
                document.getElementById('penaltyRow').style.display = 'flex';
            }
        }

        // Contract interactions
        async function stake() {
            if (!currentAccount) {
                openWalletModal();
                return;
            }
            
            const amount = document.getElementById('stakeAmount').value;
            if (!amount || parseFloat(amount) <= 0) {
                alert('Please enter an amount to stake');
                return;
            }
            
            const btn = document.getElementById('stakeBtn');
            const originalText = btn.textContent;
            
            try {
                const amountWei = ethers.parseUnits(amount, tokenDecimals);
                
                // Check allowance
                btn.textContent = 'Checking allowance...';
                const allowance = await tokenContract.allowance(currentAccount, STAKING_CONTRACT);
                
                if (allowance < amountWei) {
                    btn.textContent = 'Approving...';
                    const approveTx = await tokenContract.approve(STAKING_CONTRACT, amountWei);
                    await approveTx.wait();
                }
                
                // Stake
                btn.textContent = 'Staking...';
                const stakeTx = await stakingContract.stake(amountWei);
                await stakeTx.wait();
                
                btn.textContent = 'Staked! ‚úì';
                document.getElementById('stakeAmount').value = '';
                await updateUI();
                
                setTimeout(() => { btn.textContent = originalText; }, 2000);
                
            } catch (error) {
                console.error('Stake error:', error);
                btn.textContent = originalText;
                alert('Stake failed: ' + (error.reason || error.message));
            }
        }

        async function unstake() {
            if (!currentAccount) {
                openWalletModal();
                return;
            }
            
            const amount = document.getElementById('unstakeAmount').value;
            if (!amount || parseFloat(amount) <= 0) {
                alert('Please enter an amount to unstake');
                return;
            }
            
            const isUnlocked = document.getElementById('lockStatus').textContent.includes('Unlocked');
            if (!isUnlocked) {
                const confirm = window.confirm('‚ö†Ô∏è Your stake is still locked!\n\nUnstaking now will cost you 20% penalty.\n\nAre you sure?');
                if (!confirm) return;
            }
            
            const btn = document.getElementById('unstakeBtn');
            const originalText = btn.textContent;
            
            try {
                btn.textContent = 'Unstaking...';
                const amountWei = ethers.parseUnits(amount, tokenDecimals);
                const tx = await stakingContract.unstake(amountWei);
                await tx.wait();
                
                btn.textContent = 'Unstaked! ‚úì';
                document.getElementById('unstakeAmount').value = '';
                await updateUI();
                
                setTimeout(() => { btn.textContent = originalText; }, 2000);
                
            } catch (error) {
                console.error('Unstake error:', error);
                btn.textContent = originalText;
                alert('Unstake failed: ' + (error.reason || error.message));
            }
        }

        async function claimRewards() {
            if (!currentAccount) {
                openWalletModal();
                return;
            }
            
            const btn = document.getElementById('claimBtn');
            const originalText = btn.textContent;
            
            try {
                btn.textContent = 'Claiming...';
                const tx = await stakingContract.claimRewards();
                await tx.wait();
                
                btn.textContent = 'Claimed! ‚úì';
                await updateUI();
                
                setTimeout(() => { btn.textContent = originalText; }, 2000);
                
            } catch (error) {
                console.error('Claim error:', error);
                btn.textContent = originalText;
                alert('Claim failed: ' + (error.reason || error.message));
            }
        }

        async function exitAll() {
            if (!currentAccount) {
                openWalletModal();
                return;
            }
            
            const isUnlocked = document.getElementById('lockStatus').textContent.includes('Unlocked');
            if (!isUnlocked) {
                const confirm = window.confirm('‚ö†Ô∏è Your stake is still locked!\n\nExiting now will cost you 20% penalty on your staked amount.\n\nAre you sure?');
                if (!confirm) return;
            }
            
            const btn = document.getElementById('exitBtn');
            const originalText = btn.textContent;
            
            try {
                btn.textContent = 'Exiting...';
                const tx = await stakingContract.exit();
                await tx.wait();
                
                btn.textContent = 'Exited! ‚úì';
                await updateUI();
                
                setTimeout(() => { btn.textContent = originalText; }, 2000);
                
            } catch (error) {
                console.error('Exit error:', error);
                btn.textContent = originalText;
                alert('Exit failed: ' + (error.reason || error.message));
            }
        }

        // Listen for account/network changes
        if (window.ethereum) {
            window.ethereum.on('accountsChanged', async (accounts) => {
                if (accounts.length === 0) {
                    disconnectWallet();
                } else {
                    currentAccount = accounts[0];
                    await initContracts();
                    await updateUI();
                }
            });
            
            window.ethereum.on('chainChanged', () => {
                window.location.reload();
            });
        }

        // Initial UI update
        updateUI();
    </script>
    
    <!-- Ethers.js -->
    <script src="https://cdn.jsdelivr.net/npm/ethers@6.9.0/dist/ethers.umd.min.js"></script>
</body>
</html>