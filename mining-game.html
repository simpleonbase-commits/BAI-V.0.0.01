<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>üíé GEM MINE ‚Äî BAI Mining Terminal</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
html,body{width:100%;height:100%;overflow:hidden;background:#0a0a0f;font-family:'Courier New',monospace}
canvas{display:block;width:100%;height:100%;image-rendering:pixelated}
#upgradePanel{display:none;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);
background:rgba(10,10,20,0.95);border:2px solid #00ffc8;border-radius:12px;padding:24px;
color:#eee;z-index:100;min-width:340px;max-height:80vh;overflow-y:auto;box-shadow:0 0 40px rgba(0,255,200,0.3)}
#upgradePanel h2{color:#00ffc8;text-align:center;margin-bottom:16px;text-shadow:0 0 10px #00ffc8}
.upg-btn{display:block;width:100%;padding:10px 14px;margin:6px 0;background:rgba(0,255,200,0.08);
border:1px solid rgba(0,255,200,0.3);border-radius:6px;color:#eee;cursor:pointer;text-align:left;
font-family:'Courier New',monospace;font-size:13px;transition:all .2s}
.upg-btn:hover{background:rgba(0,255,200,0.2);border-color:#00ffc8}
.upg-btn:disabled{opacity:0.4;cursor:default}
.upg-btn .cost{color:#ffd700;float:right}
.upg-btn .owned{color:#00ffc8;float:right}
#upgradePanel .close-btn{display:block;margin:12px auto 0;padding:8px 24px;background:transparent;
border:1px solid #ff4466;color:#ff4466;border-radius:6px;cursor:pointer;font-family:'Courier New',monospace}
</style>
</head>
<body>
<canvas id="c"></canvas>
<div id="upgradePanel">
<h2>‚öíÔ∏è UPGRADE SHOP</h2>
<div id="upgList"></div>
<button class="close-btn" onclick="toggleShop()">CLOSE [E]</button>
</div>
<script>
"use strict";
// ========== PERLIN NOISE ==========
const Perlin=(()=>{const p=new Uint8Array(512);const perm=new Uint8Array(256);
for(let i=0;i<256;i++)perm[i]=i;
for(let i=255;i>0;i--){const j=Math.floor(Math.random()*(i+1));[perm[i],perm[j]]=[perm[j],perm[i]]}
for(let i=0;i<512;i++)p[i]=perm[i&255];
const fade=t=>t*t*t*(t*(t*6-15)+10);
const lerp=(t,a,b)=>a+t*(b-a);
const grad=(hash,x,y)=>{const h=hash&3;return((h&1)?-x:x)+((h&2)?-y:y)};
return{noise2d:(x,y)=>{const X=Math.floor(x)&255,Y=Math.floor(y)&255;
x-=Math.floor(x);y-=Math.floor(y);
const u=fade(x),v=fade(y);
const a=p[X]+Y,b=p[X+1]+Y;
return lerp(v,lerp(u,grad(p[a],x,y),grad(p[b],x-1,y)),
lerp(u,grad(p[a+1],x,y-1),grad(p[b+1],x-1,y-1)))}};
})();
function fbm(x,y,oct=4){let v=0,a=1,f=1,m=0;
for(let i=0;i<oct;i++){v+=a*Perlin.noise2d(x*f,y*f);m+=a;a*=0.5;f*=2}return v/m}

// ========== CONSTANTS ==========
const TILE=32,CHUNK=16;
const canvas=document.getElementById('c');
const ctx=canvas.getContext('2d');
let W,H;
function resize(){W=canvas.width=window.innerWidth;H=canvas.height=window.innerHeight}
resize();window.addEventListener('resize',resize);

// ========== ORE DEFINITIONS ==========
const ORES={
coal:{name:'Coal',color:'#333333',value:1,hits:1,rarity:'common',glow:false},
copper:{name:'Copper',color:'#b87333',value:3,hits:1,rarity:'common',glow:false},
iron:{name:'Iron',color:'#a19d94',value:5,hits:2,rarity:'uncommon',glow:false},
silver:{name:'Silver',color:'#c0c0c0',value:10,hits:2,rarity:'uncommon',glow:true},
gold:{name:'Gold',color:'#ffd700',value:25,hits:3,rarity:'rare',glow:true},
sapphire:{name:'Sapphire',color:'#0f52ba',value:50,hits:3,rarity:'rare',glow:true},
ruby:{name:'Ruby',color:'#e0115f',value:100,hits:4,rarity:'epic',glow:true},
diamond:{name:'Diamond',color:'#b9f2ff',value:250,hits:5,rarity:'epic',glow:true},
gem:{name:'GEM üíé',color:'#00ffc8',value:1000,hits:6,rarity:'legendary',glow:true}
};

// ========== TILE TYPES ==========
const T={AIR:0,DIRT:1,STONE:2,GRASS:3,ORE:4,LAVA:5,GAS:6,BEDROCK:7};

// ========== BIOME HELPERS ==========
function getBiome(depth){
if(depth<0)return'sky';if(depth<=10)return'surface';if(depth<=50)return'dirt';
if(depth<=150)return'stone';if(depth<=300)return'crystal';if(depth<=500)return'magma';return'void'}
function biomeColor(biome){
switch(biome){case'sky':return'#87ceeb';case'surface':return'#4a7c3f';case'dirt':return'#8b6914';
case'stone':return'#6b6b6b';case'crystal':return'#2a1a4e';case'magma':return'#4a1a0a';case'void':return'#0a0010';default:return'#333'}}
function biomeBg(depth){
if(depth<0)return['#87ceeb','#6bb5d9'];if(depth<=10)return['#3a6630','#2d5025'];
if(depth<=50)return['#5c4a1e','#4a3a14'];if(depth<=150)return['#3a3a3a','#2a2a2a'];
if(depth<=300)return['#1a0a3e','#2a1a5e'];if(depth<=500)return['#3a0a0a','#5a1a0a'];
return['#050008','#0a0010']}

// ========== WORLD ==========
const world=new Map();
const chunks=new Set();
const explored=new Set();

function tileKey(x,y){return x+','+y}
function chunkKey(cx,cy){return cx+','+cy}

function getOreForDepth(depth,rng){
const biome=getBiome(depth);
let ores=[];
if(biome==='dirt'){ores=[{type:'coal',w:0.08},{type:'copper',w:0.05}]}
else if(biome==='stone'){ores=[{type:'coal',w:0.04},{type:'copper',w:0.03},{type:'iron',w:0.05},{type:'silver',w:0.025}]}
else if(biome==='crystal'){ores=[{type:'iron',w:0.02},{type:'silver',w:0.03},{type:'gold',w:0.04},{type:'sapphire',w:0.02}]}
else if(biome==='magma'){ores=[{type:'gold',w:0.02},{type:'sapphire',w:0.015},{type:'ruby',w:0.03},{type:'diamond',w:0.01}]}
else if(biome==='void'){ores=[{type:'ruby',w:0.015},{type:'diamond',w:0.02},{type:'gem',w:0.008}]}
for(const o of ores){if(rng<o.w){return o.type}rng-=o.w}
return null}

function generateChunk(cx,cy){
const key=chunkKey(cx,cy);
if(chunks.has(key))return;
chunks.add(key);
const bx=cx*CHUNK,by=cy*CHUNK;
for(let y=0;y<CHUNK;y++){
for(let x=0;x<CHUNK;x++){
const wx=bx+x,wy=by+y;
const tk=tileKey(wx,wy);
if(world.has(tk))continue;
const depth=wy;
if(depth<-2){world.set(tk,{type:T.AIR});continue}
if(depth<0){
const n=fbm(wx*0.1,wy*0.1,3);
world.set(tk,{type:n>0.1?T.AIR:T.DIRT});continue}
if(depth===0){world.set(tk,{type:T.GRASS});continue}
const n=fbm(wx*0.08,wy*0.06,4);
const cave=fbm(wx*0.05+100,wy*0.05+100,3);
if(cave>0.3&&depth>5){world.set(tk,{type:T.AIR});continue}
const biome=getBiome(depth);
// Lava
if(biome==='magma'||biome==='void'){
const lavaN=fbm(wx*0.12+200,wy*0.12+200,2);
if(lavaN>0.35&&n>-0.1){world.set(tk,{type:T.LAVA,dmgTimer:0});continue}}
// Gas pockets
if((biome==='stone'||biome==='crystal')&&fbm(wx*0.15+300,wy*0.15+300,2)>0.45&&Math.random()<0.15){
world.set(tk,{type:T.GAS});continue}
// Ore check
const oreRng=Math.abs(fbm(wx*0.2+50,wy*0.2+50,2))*0.5+Math.random()*0.5;
const oreType=getOreForDepth(depth,oreRng*0.15);
if(oreType){
const od=ORES[oreType];
world.set(tk,{type:T.ORE,ore:oreType,hitsLeft:od.hits,maxHits:od.hits});continue}
// Base block
if(depth<=10)world.set(tk,{type:T.DIRT});
else if(depth<=50)world.set(tk,{type:n>0?T.DIRT:T.STONE});
else world.set(tk,{type:T.STONE});
}}}

function ensureChunks(px,py){
const cx=Math.floor(px/CHUNK),cy=Math.floor(py/CHUNK);
for(let dy=-2;dy<=2;dy++)for(let dx=-2;dx<=2;dx++)generateChunk(cx+dx,cy+dy)}

function getTile(x,y){return world.get(tileKey(x,y))||null}
function setTile(x,y,tile){world.set(tileKey(x,y),tile)}

// ========== PLAYER ==========
const player={
x:20,y:-1,vx:0,vy:0,
hp:100,maxHp:100,
gems:0,
inventory:{coal:0,copper:0,iron:0,silver:0,gold:0,sapphire:0,ruby:0,diamond:0,gem:0},
pickLevel:0,// 0=basic,1=iron,2=steel,3=diamond
lightRadius:5,
hasArmor:false,
hasJetpack:false,
bombs:0,
miningTarget:null,
miningProgress:0,
onGround:false,
facing:1,
idleTime:0,
dead:false,
maxDepth:0,
totalOres:0,
moveAnim:0,
dmgCooldown:0,
jumpCount:0
};

// ========== UPGRADES ==========
const upgrades=[
{id:'iron_pick',name:'Iron Pickaxe',cost:50,desc:'Mine 2x faster',
check:()=>player.pickLevel<1,apply:()=>{player.pickLevel=1}},
{id:'steel_pick',name:'Steel Pickaxe',cost:200,desc:'Mine 3x faster',
check:()=>player.pickLevel<2,apply:()=>{player.pickLevel=2}},
{id:'diamond_pick',name:'Diamond Pickaxe',cost:1000,desc:'Mine 5x faster',
check:()=>player.pickLevel<3,apply:()=>{player.pickLevel=3}},
{id:'lantern',name:'Lantern',cost:100,desc:'Bigger light radius',
check:()=>player.lightRadius<9,apply:()=>{player.lightRadius=9}},
{id:'armor',name:'Armor',cost:150,desc:'Reduce damage 50%',
check:()=>!player.hasArmor,apply:()=>{player.hasArmor=true}},
{id:'jetpack',name:'Jetpack',cost:500,desc:'Press W/UP to fly',
check:()=>!player.hasJetpack,apply:()=>{player.hasJetpack=true}},
{id:'bombs',name:'Bombs x3',cost:75,desc:'Press B to blast 3x3',
check:()=>true,apply:()=>{player.bombs+=3}}
];

// ========== PARTICLES ==========
let particles=[];
function spawnParticles(x,y,color,count=8){
for(let i=0;i<count;i++){
particles.push({x:x*TILE+TILE/2,y:y*TILE+TILE/2,
vx:(Math.random()-0.5)*4,vy:(Math.random()-0.5)*4-2,
life:30+Math.random()*20,maxLife:50,color,size:2+Math.random()*3})}}
function updateParticles(){
particles=particles.filter(p=>{p.x+=p.vx;p.y+=p.vy;p.vy+=0.1;p.life--;return p.life>0})}

// ========== SCREEN SHAKE ==========
let shakeX=0,shakeY=0,shakeAmount=0;
function shake(amount){shakeAmount=Math.max(shakeAmount,amount)}
function updateShake(){
if(shakeAmount>0){shakeX=(Math.random()-0.5)*shakeAmount;shakeY=(Math.random()-0.5)*shakeAmount;shakeAmount*=0.85;
if(shakeAmount<0.5)shakeAmount=0}else{shakeX=0;shakeY=0}}

// ========== FLOATING TEXT ==========
let floatingTexts=[];
function floatText(x,y,text,color='#ffd700'){
floatingTexts.push({x:x*TILE+TILE/2,y:y*TILE,text,color,life:60,vy:-1.5})}
function updateFloats(){
floatingTexts=floatingTexts.filter(f=>{f.y+=f.vy;f.life--;return f.life>0})}

// ========== AUDIO ==========
let audioCtx=null;
function initAudio(){if(!audioCtx)audioCtx=new(window.AudioContext||window.webkitAudioContext)()}
function playTone(freq,dur=0.08,vol=0.12,type='square'){
if(!audioCtx)return;try{
const o=audioCtx.createOscillator(),g=audioCtx.createGain();
o.type=type;o.frequency.value=freq;
g.gain.setValueAtTime(vol,audioCtx.currentTime);
g.gain.exponentialRampToValueAtTime(0.001,audioCtx.currentTime+dur);
o.connect(g);g.connect(audioCtx.destination);o.start();o.stop(audioCtx.currentTime+dur)}catch(e){}}
function sndMine(){playTone(400+Math.random()*200,0.05,0.08)}
function sndOre(val){const f=300+Math.min(val,500)*2;playTone(f,0.15,0.1,'sine');
setTimeout(()=>playTone(f*1.25,0.15,0.08,'sine'),80);
setTimeout(()=>playTone(f*1.5,0.2,0.06,'sine'),160)}
function sndDamage(){playTone(100,0.2,0.15,'sawtooth')}
function sndExplode(){playTone(60,0.3,0.2,'sawtooth');setTimeout(()=>playTone(40,0.3,0.15,'sawtooth'),50)}

// ========== AMBIENT SOUND ==========
let ambientOsc=null,ambientGain=null;
function startAmbient(){
if(!audioCtx||ambientOsc)return;
try{ambientOsc=audioCtx.createOscillator();ambientGain=audioCtx.createGain();
ambientOsc.type='sine';ambientOsc.frequency.value=40;
ambientGain.gain.value=0;
ambientOsc.connect(ambientGain);ambientGain.connect(audioCtx.destination);
ambientOsc.start()}catch(e){}}
function updateAmbient(){
if(!ambientGain)return;
const d=Math.max(0,player.y);
const intensity=Math.min(d/500,1);
ambientGain.gain.value=0.02+intensity*0.04;
ambientOsc.frequency.value=35+intensity*25}

// ========== INPUT ==========
const keys={};
window.addEventListener('keydown',e=>{keys[e.key.toLowerCase()]=true;
if(['arrowup','arrowdown','arrowleft','arrowright',' '].includes(e.key.toLowerCase()))e.preventDefault()});
window.addEventListener('keyup',e=>{keys[e.key.toLowerCase()]=false});

// Touch
let touchDir={x:0,y:0};let touching=false;
canvas.addEventListener('touchstart',e=>{e.preventDefault();touching=true;initAudio();
handleTouch(e.touches[0])},{passive:false});
canvas.addEventListener('touchmove',e=>{e.preventDefault();if(touching)handleTouch(e.touches[0])},{passive:false});
canvas.addEventListener('touchend',e=>{e.preventDefault();touching=false;touchDir={x:0,y:0}},{passive:false});
function handleTouch(t){
const cx=W/2,cy=H/2;
const dx=t.clientX-cx,dy=t.clientY-cy;
const dist=Math.sqrt(dx*dx+dy*dy);
if(dist<20){touchDir={x:0,y:0};return}
touchDir={x:dx/dist,y:dy/dist}}

// ========== GAME STATE ==========
let gameState='menu'; // menu, playing, dead, shop
let camX=0,camY=0;
let time=0;
let moveTimer=0;
const MOVE_DELAY=6; // frames between moves

// ========== SHOP ==========
const panel=document.getElementById('upgradePanel');
const upgList=document.getElementById('upgList');
let shopOpen=false;
function toggleShop(){
if(gameState!=='playing')return;
shopOpen=!shopOpen;
panel.style.display=shopOpen?'block':'none';
if(shopOpen)renderShop()}
function renderShop(){
upgList.innerHTML='';
upgrades.forEach(u=>{
const btn=document.createElement('button');btn.className='upg-btn';
const canBuy=u.check()&&player.gems>=u.cost;
btn.disabled=!canBuy;
if(!u.check()){btn.innerHTML=`${u.name} ‚Äî ${u.desc} <span class="owned">OWNED</span>`}
else{btn.innerHTML=`${u.name} ‚Äî ${u.desc} <span class="cost">üíé ${u.cost}</span>`}
btn.onclick=()=>{if(canBuy){player.gems-=u.cost;u.apply();playTone(600,0.1,0.1,'sine');
setTimeout(()=>playTone(900,0.15,0.1,'sine'),100);renderShop()}};
upgList.appendChild(btn)})}

// ========== FALLING ROCKS (cave-ins) ==========
let fallingRocks=[];
function spawnCaveIn(px,py){
const count=2+Math.floor(Math.random()*3);
for(let i=0;i<count;i++){
fallingRocks.push({x:(px-2+Math.random()*5)*TILE,y:(py-8-Math.random()*4)*TILE,
vy:1+Math.random()*2,life:120,size:TILE*0.6})}}
function updateRocks(){
fallingRocks=fallingRocks.filter(r=>{
r.y+=r.vy;r.vy+=0.15;r.life--;
const tx=Math.floor(r.x/TILE),ty=Math.floor(r.y/TILE);
const t=getTile(tx,ty);
if(t&&t.type!==T.AIR&&t.type!==T.LAVA){r.life=0;spawnParticles(tx,ty,'#888',4)}
if(Math.abs(r.x-player.x*TILE)<TILE&&Math.abs(r.y-player.y*TILE)<TILE){
damagePlayer(5);r.life=0}
return r.life>0})}

// ========== GAME LOGIC ==========
function damagePlayer(amount){
if(player.dmgCooldown>0)return;
if(player.hasArmor)amount=Math.ceil(amount/2);
player.hp-=amount;player.dmgCooldown=30;
sndDamage();shake(8);
if(player.hp<=0){player.hp=0;player.dead=true;gameState='dead'}}

function mineBlock(tx,ty){
const tile=getTile(tx,ty);
if(!tile)return false;
if(tile.type===T.AIR)return true;
if(tile.type===T.LAVA){damagePlayer(10);return false}
if(tile.type===T.BEDROCK)return false;
if(tile.type===T.GAS){
// Explosion
sndExplode();shake(15);
for(let dy=-1;dy<=1;dy++)for(let dx=-1;dx<=1;dx++){
const nx=tx+dx,ny=ty+dy;const nt=getTile(nx,ny);
if(nt&&nt.type!==T.AIR){setTile(nx,ny,{type:T.AIR});spawnParticles(nx,ny,'#44ff44',5)}}
damagePlayer(15);
floatText(tx,ty,'GAS EXPLOSION!','#44ff44');
return true}
const speed=[1,2,3,5][player.pickLevel]||1;
if(tile.type===T.ORE){
tile.hitsLeft-=speed;
sndMine();
spawnParticles(tx,ty,ORES[tile.ore].color,3);
if(tile.hitsLeft<=0){
const ore=ORES[tile.ore];
player.gems+=ore.value;
player.inventory[tile.ore]=(player.inventory[tile.ore]||0)+1;
player.totalOres++;
sndOre(ore.value);
floatText(tx,ty,`+${ore.value} üíé`,ore.color);
setTile(tx,ty,{type:T.AIR});
// Cave-in chance
if(player.y>100&&Math.random()<0.04)spawnCaveIn(player.x,player.y);
return true}
return false}
// Regular block
tile.type===T.GRASS||tile.type===T.DIRT?spawnParticles(tx,ty,'#8b6914',4):spawnParticles(tx,ty,'#777',4);
sndMine();
if(speed>=3||tile.type===T.DIRT||tile.type===T.GRASS){setTile(tx,ty,{type:T.AIR});return true}
// Multi-hit for stone with basic pick
if(!tile._hp){tile._hp=2}
tile._hp-=speed;
if(tile._hp<=0){setTile(tx,ty,{type:T.AIR});return true}
return false}

function useBomb(){
if(player.bombs<=0)return;
player.bombs--;
sndExplode();shake(20);
for(let dy=-1;dy<=1;dy++)for(let dx=-1;dx<=1;dx++){
const nx=player.x+dx,ny=player.y+dy;
const t=getTile(nx,ny);
if(t&&t.type!==T.AIR&&t.type!==T.BEDROCK){
if(t.type===T.ORE){
const ore=ORES[t.ore];player.gems+=ore.value;
player.inventory[t.ore]=(player.inventory[t.ore]||0)+1;player.totalOres++}
setTile(nx,ny,{type:T.AIR});spawnParticles(nx,ny,'#ff8844',6)}}}

function tryMove(dx,dy){
const nx=player.x+dx,ny=player.y+dy;
const tile=getTile(nx,ny);
if(!tile)return;
if(tile.type===T.AIR||tile.type===T.LAVA){
if(tile.type===T.LAVA)damagePlayer(10);
player.x=nx;player.y=ny;player.facing=dx!==0?dx:player.facing;
player.moveAnim=10;
explored.add(tileKey(nx,ny));
}else{
// Mine it
mineBlock(nx,ny);
player.facing=dx!==0?dx:player.facing}
player.maxDepth=Math.max(player.maxDepth,player.y)}

function updatePlayer(){
if(player.dead)return;
player.dmgCooldown=Math.max(0,player.dmgCooldown-1);
if(player.moveAnim>0)player.moveAnim--;
// Gravity
const below=getTile(player.x,player.y+1);
player.onGround=below&&below.type!==T.AIR&&below.type!==T.LAVA;
if(!player.onGround){
// Fall
const fallTile=getTile(player.x,player.y+1);
if(fallTile&&(fallTile.type===T.AIR||fallTile.type===T.LAVA)){
if(fallTile.type===T.LAVA)damagePlayer(10);
player.y++;player.maxDepth=Math.max(player.maxDepth,player.y)}}
// Regen
if(player.onGround&&!keys.a&&!keys.d&&!keys.arrowleft&&!keys.arrowright&&!touching){
player.idleTime++;
if(player.idleTime%120===0&&player.hp<player.maxHp)player.hp=Math.min(player.maxHp,player.hp+1)
}else{player.idleTime=0}
// Movement
moveTimer++;
if(moveTimer>=MOVE_DELAY){
let mx=0,my=0;
if(keys.a||keys.arrowleft)mx=-1;
else if(keys.d||keys.arrowright)mx=1;
if(keys.w||keys.arrowup){
if(player.hasJetpack){my=-1}
else if(player.onGround){my=-1}}
else if(keys.s||keys.arrowdown)my=1;
// Touch
if(touching&&mx===0&&my===0){
if(Math.abs(touchDir.x)>Math.abs(touchDir.y)){mx=touchDir.x>0?1:-1}
else{my=touchDir.y>0?1:-1}}
if(mx!==0||my!==0){
if(my!==0&&mx!==0){tryMove(mx,0);moveTimer=MOVE_DELAY-2}
else if(mx!==0){tryMove(mx,0);moveTimer=0}
else{tryMove(0,my);moveTimer=0}
}else{moveTimer=MOVE_DELAY-1}}
// Lava contact check
const ct=getTile(player.x,player.y);
if(ct&&ct.type===T.LAVA){damagePlayer(10)}
ensureChunks(player.x,player.y)}

// ========== RENDERING ==========
function drawTile(x,y,tile,sx,sy){
if(!tile||tile.type===T.AIR)return;
const depth=y;const biome=getBiome(depth);
let c;
switch(tile.type){
case T.GRASS:c='#4a7c3f';break;
case T.DIRT:c=depth<30?'#8b6914':'#6b4e12';break;
case T.STONE:
if(biome==='crystal')c=`hsl(${260+Math.sin(x*0.3+y*0.2)*20},30%,${25+Math.sin(x*0.5)*5}%)`;
else c=`hsl(0,0%,${35+Math.sin(x*0.4+y*0.3)*8}%)`;break;
case T.LAVA:{
const flicker=Math.sin(time*0.1+x*0.5+y*0.7)*20;
c=`hsl(${15+flicker},90%,${45+Math.sin(time*0.15+x)*10}%)`;break}
case T.GAS:c=`rgba(80,${200+Math.sin(time*0.1)*30},80,0.7)`;break;
case T.ORE:{
const ore=ORES[tile.ore];
c=ore.color;
// Glow effect for rare ores
if(ore.glow){
const pulse=Math.sin(time*0.08+x+y)*0.3+0.7;
ctx.globalAlpha=0.3*pulse;
ctx.fillStyle=ore.color;
ctx.fillRect(sx-3,sy-3,TILE+6,TILE+6);
ctx.globalAlpha=1}
// GEM shimmer
if(tile.ore==='gem'){
const hue=(time*3+x*20+y*20)%360;
c=`hsl(${hue},90%,65%)`;
ctx.globalAlpha=0.4;
ctx.fillStyle=`hsl(${hue},100%,80%)`;
ctx.fillRect(sx-4,sy-4,TILE+8,TILE+8);
ctx.globalAlpha=1}
break}
default:c='#444'}
ctx.fillStyle=c;ctx.fillRect(sx,sy,TILE,TILE);
// Tile detail
if(tile.type===T.ORE){
// Draw ore specks
ctx.fillStyle=tile.ore==='gem'?'#fff':'rgba(255,255,255,0.3)';
const seed=x*73+y*137;
for(let i=0;i<3;i++){
const ox=(((seed+i*41)%13)/13)*TILE*0.6+TILE*0.15;
const oy=(((seed+i*67)%11)/11)*TILE*0.6+TILE*0.15;
const s=tile.ore==='gem'?4:3;
ctx.fillRect(sx+ox,sy+oy,s,s)}
// Mining progress
if(tile.hitsLeft<tile.maxHits){
const pct=tile.hitsLeft/tile.maxHits;
ctx.strokeStyle='rgba(255,255,255,0.5)';ctx.lineWidth=1;
const cracks=Math.floor((1-pct)*4);
for(let i=0;i<cracks;i++){
ctx.beginPath();
ctx.moveTo(sx+TILE*Math.random(),sy+TILE*Math.random());
ctx.lineTo(sx+TILE*Math.random(),sy+TILE*Math.random());
ctx.stroke()}}}
if(tile.type===T.GRASS){ctx.fillStyle='#5a9c4f';ctx.fillRect(sx,sy,TILE,3)}
if(tile.type===T.DIRT||tile.type===T.STONE){
ctx.fillStyle='rgba(0,0,0,0.1)';
ctx.fillRect(sx,sy+TILE-2,TILE,2)}}

function drawPlayer(sx,sy){
const p=player;const f=p.facing;
const bob=p.moveAnim>0?Math.sin(time*0.5)*2:0;
const py=sy+bob;
// Body
ctx.fillStyle=p.dmgCooldown>0&&time%6<3?'#ff4444':'#00e5b0';
ctx.fillRect(sx+8,py+6,16,18);
// Head
ctx.fillStyle=p.dmgCooldown>0&&time%6<3?'#ff6666':'#00ffc8';
ctx.fillRect(sx+9,py+0,14,10);
// Eyes
ctx.fillStyle='#fff';
const ex=f>0?18:8;
ctx.fillRect(sx+ex,py+3,4,4);
ctx.fillStyle='#111';
ctx.fillRect(sx+ex+(f>0?1:1),py+4,2,2);
// Hard hat
ctx.fillStyle='#ffd700';
ctx.fillRect(sx+7,py-2,18,4);
ctx.fillRect(sx+10,py-4,12,3);
// Pickaxe
if(p.moveAnim>0){
ctx.fillStyle=['#888','#aaa','#ccc','#b9f2ff'][p.pickLevel];
const px2=f>0?sx+26:sx-4;
const swing=Math.sin(time*0.8)*6;
ctx.fillRect(px2,py+8+swing,4,14);
ctx.fillRect(px2-2,py+6+swing,8,3)}
// Armor
if(p.hasArmor){
ctx.fillStyle='rgba(100,150,255,0.3)';
ctx.fillRect(sx+6,py+5,20,20)}
// Jetpack flames
if(p.hasJetpack&&(keys.w||keys.arrowup)){
ctx.fillStyle=`hsl(${20+Math.random()*20},100%,60%)`;
ctx.fillRect(sx+10,py+24,4,4+Math.random()*6);
ctx.fillRect(sx+18,py+24,4,4+Math.random()*6)}
// Light effect in dark areas
const depth=p.y;
if(depth>300){
const grad=ctx.createRadialGradient(sx+16,py+12,0,sx+16,py+12,p.lightRadius*TILE);
grad.addColorStop(0,'rgba(255,240,200,0.15)');
grad.addColorStop(1,'rgba(255,240,200,0)');
ctx.fillStyle=grad;
ctx.fillRect(sx+16-p.lightRadius*TILE,py+12-p.lightRadius*TILE,p.lightRadius*TILE*2,p.lightRadius*TILE*2)}}

function drawDarkness(){
const depth=player.y;
if(depth<=250)return;
const factor=Math.min((depth-250)/100,1);
if(factor<=0)return;
const px=(player.x*TILE-camX)+W/2+TILE/2;
const py=(player.y*TILE-camY)+H/2+TILE/2;
const radius=player.lightRadius*TILE*(1.5-factor*0.5);
const grad=ctx.createRadialGradient(px,py,radius*0.2,px,py,radius);
grad.addColorStop(0,`rgba(0,0,0,0)`);
grad.addColorStop(0.7,`rgba(0,0,0,${factor*0.3})`);
grad.addColorStop(1,`rgba(0,0,0,${factor*0.85})`);
ctx.fillStyle=grad;ctx.fillRect(0,0,W,H);
// Additional darkness overlay for far areas
if(factor>0.5){
ctx.fillStyle=`rgba(0,0,0,${(factor-0.5)*0.5})`;
ctx.fillRect(0,0,W,H)}}

// ========== VOID PARTICLES ==========
let voidParts=[];
for(let i=0;i<50;i++){voidParts.push({x:Math.random()*2000-1000,y:Math.random()*2000-1000,
s:1+Math.random()*2,sp:0.2+Math.random()*0.5})}

function drawVoidParticles(){
if(player.y<450)return;
const alpha=Math.min((player.y-450)/100,0.6);
ctx.fillStyle=`rgba(180,100,255,${alpha})`;
voidParts.forEach(p=>{
p.y-=p.sp;if(p.y<-1000)p.y=1000;
const sx=p.x-camX+W/2,sy=p.y-camY+H/2;
if(sx>-20&&sx<W+20&&sy>-20&&sy<H+20){
ctx.beginPath();ctx.arc(sx,sy,p.s,0,Math.PI*2);ctx.fill()}})}

// ========== HUD ==========
function drawHUD(){
const depth=Math.max(0,Math.floor(player.y));
const biome=getBiome(depth);
// Title
ctx.textAlign='center';
ctx.font='bold 16px "Courier New"';
ctx.fillStyle='#00ffc8';
ctx.shadowColor='#00ffc8';ctx.shadowBlur=12;
ctx.fillText('BAI MINING TERMINAL',W/2,24);
ctx.shadowBlur=0;
// Depth
ctx.textAlign='left';
ctx.font='bold 14px "Courier New"';
ctx.fillStyle='#ccc';
ctx.fillText(`Depth: ${depth}m`,12,24);
ctx.font='11px "Courier New"';
const biomeNames={sky:'Sky',surface:'Surface',dirt:'Dirt Layer',stone:'Stone Layer',
crystal:'Crystal Caves',magma:'Magma Zone',void:'The Void'};
ctx.fillStyle=biome==='void'?'#bb66ff':biome==='magma'?'#ff6644':biome==='crystal'?'#8866ff':'#888';
ctx.fillText(biomeNames[biome]||'',12,40);
// GEM score
ctx.textAlign='right';ctx.font='bold 16px "Courier New"';
ctx.fillStyle='#ffd700';
ctx.shadowColor='#ffd700';ctx.shadowBlur=8;
ctx.fillText(`üíé ${player.gems} GEM`,W-16,24);
ctx.shadowBlur=0;
// Bombs
if(player.bombs>0){
ctx.font='12px "Courier New"';ctx.fillStyle='#ff8844';
ctx.fillText(`üí£ ${player.bombs} [B]`,W-16,42)}
// Health bar
const barW=200,barH=14,barX=(W-barW)/2,barY=H-30;
ctx.fillStyle='rgba(0,0,0,0.6)';
ctx.fillRect(barX-2,barY-2,barW+4,barH+4);
const hpPct=player.hp/player.maxHp;
const hpR=Math.floor(255*(1-hpPct)),hpG=Math.floor(255*hpPct);
ctx.fillStyle=`rgb(${hpR},${hpG},60)`;
ctx.fillRect(barX,barY,barW*hpPct,barH);
ctx.strokeStyle='#555';ctx.lineWidth=1;ctx.strokeRect(barX,barY,barW,barH);
ctx.textAlign='center';ctx.font='bold 11px "Courier New"';ctx.fillStyle='#fff';
ctx.fillText(`HP ${player.hp}/${player.maxHp}`,W/2,barY+11);
// Pickaxe indicator
ctx.textAlign='right';ctx.font='11px "Courier New"';
const pickNames=['Basic','Iron','Steel','Diamond'];
const pickColors=['#888','#aaa','#ccc','#b9f2ff'];
ctx.fillStyle=pickColors[player.pickLevel];
ctx.fillText(`‚õè ${pickNames[player.pickLevel]} Pickaxe`,W-16,H-20);
// Inventory
ctx.textAlign='left';ctx.font='11px "Courier New"';
let iy=60;
ctx.fillStyle='rgba(0,0,0,0.5)';ctx.fillRect(0,50,130,Object.keys(ORES).length*18+10);
for(const[key,ore]of Object.entries(ORES)){
const count=player.inventory[key]||0;
if(count>0){
ctx.fillStyle=ore.color;ctx.fillRect(8,iy-6,8,8);
ctx.fillStyle='#ddd';ctx.fillText(`${ore.name}: ${count}`,20,iy);
iy+=16}}
// Minimap
drawMinimap();
// Shop hint
ctx.textAlign='center';ctx.font='11px "Courier New"';
ctx.fillStyle='rgba(0,255,200,0.5)';
ctx.fillText('[E] Shop   [B] Bomb',W/2,H-48)}

function drawMinimap(){
const mmW=100,mmH=80;
const mmX=W-mmW-10,mmY=36;
ctx.fillStyle='rgba(0,0,0,0.7)';ctx.fillRect(mmX,mmY,mmW,mmH);
ctx.strokeStyle='#00ffc860';ctx.lineWidth=1;ctx.strokeRect(mmX,mmY,mmW,mmH);
const scale=2;
const cx=player.x,cy=player.y;
const halfW=Math.floor(mmW/(scale*2)),halfH=Math.floor(mmH/(scale*2));
for(let dy=-halfH;dy<=halfH;dy++){
for(let dx=-halfW;dx<=halfW;dx++){
const tx=cx+dx,ty=cy+dy;
const tile=getTile(tx,ty);
if(!tile)continue;
const sx=mmX+mmW/2+dx*scale,sy=mmY+mmH/2+dy*scale;
let c;
if(tile.type===T.AIR)continue;
else if(tile.type===T.ORE)c=ORES[tile.ore].color;
else if(tile.type===T.LAVA)c='#ff4400';
else if(tile.type===T.GAS)c='#44ff44';
else{const b=getBiome(ty);c=biomeColor(b)}
ctx.fillStyle=c;ctx.fillRect(sx,sy,scale,scale)}}
// Player dot
ctx.fillStyle='#00ffc8';
ctx.fillRect(mmX+mmW/2-1,mmY+mmH/2-1,3,3)}

// ========== MENU ==========
let menuParticles=[];
for(let i=0;i<60;i++){menuParticles.push({x:Math.random()*2000,y:Math.random()*2000,
vy:1+Math.random()*3,size:3+Math.random()*8,hue:Math.random()*60+160,alpha:0.3+Math.random()*0.5})}

function drawMenu(){
ctx.fillStyle='#0a0a0f';ctx.fillRect(0,0,W,H);
// Animated particles
menuParticles.forEach(p=>{
p.y+=p.vy;if(p.y>H+20){p.y=-20;p.x=Math.random()*W}
ctx.fillStyle=`hsla(${p.hue},80%,60%,${p.alpha*Math.sin(time*0.02+p.x)*0.5+0.5})`;
ctx.beginPath();
// Diamond shape
const s=p.size;
ctx.moveTo(p.x,p.y-s);ctx.lineTo(p.x+s*0.6,p.y);
ctx.lineTo(p.x,p.y+s);ctx.lineTo(p.x-s*0.6,p.y);ctx.closePath();ctx.fill()});
// Title
ctx.textAlign='center';
ctx.font='bold 52px "Courier New"';
const hue=(time*2)%360;
ctx.fillStyle=`hsl(${hue},80%,70%)`;
ctx.shadowColor='#00ffc8';ctx.shadowBlur=30;
ctx.fillText('üíé GEM MINE üíé',W/2,H*0.25);
ctx.shadowBlur=0;
ctx.font='bold 18px "Courier New"';
ctx.fillStyle='#00ffc8';
ctx.fillText('Bureau of Agent Investigations',W/2,H*0.25+40);
ctx.font='14px "Courier New"';
ctx.fillStyle='#ffd700';
ctx.fillText('$GEM on Base',W/2,H*0.25+65);
ctx.font='11px "Courier New"';
ctx.fillStyle='#888';
ctx.fillText('CA: 0xD3776969966B340d72d75731eF890A3Bc9F21bA3',W/2,H*0.25+90);
// Instructions
ctx.font='14px "Courier New"';
ctx.fillStyle='#aaa';
ctx.fillText('WASD to move ‚Ä¢ E for upgrades ‚Ä¢ Go deep, find üíé GEM',W/2,H*0.6);
// Start prompt
const blink=Math.sin(time*0.08)>0;
if(blink){
ctx.font='bold 18px "Courier New"';
ctx.fillStyle='#00ffc8';
ctx.shadowColor='#00ffc8';ctx.shadowBlur=15;
ctx.fillText('[PRESS ENTER OR TAP TO BEGIN]',W/2,H*0.72);
ctx.shadowBlur=0}
// Footer
ctx.font='10px "Courier New"';
ctx.fillStyle='#555';
ctx.fillText('Powered by $GEM on Base',W/2,H-20)}

function drawDeath(){
ctx.fillStyle='rgba(80,0,0,0.8)';ctx.fillRect(0,0,W,H);
ctx.textAlign='center';
ctx.font='bold 48px "Courier New"';
ctx.fillStyle='#ff3333';
ctx.shadowColor='#ff0000';ctx.shadowBlur=20;
ctx.fillText('MINE COLLAPSED',W/2,H*0.3);
ctx.shadowBlur=0;
ctx.font='18px "Courier New"';ctx.fillStyle='#ffd700';
ctx.fillText(`Depth reached: ${player.maxDepth}m`,W/2,H*0.45);
ctx.fillText(`üíé GEM earned: ${player.gems}`,W/2,H*0.52);
ctx.fillText(`Ores mined: ${player.totalOres}`,W/2,H*0.59);
ctx.font='bold 16px "Courier New"';
const blink=Math.sin(time*0.08)>0;
ctx.fillStyle=blink?'#00ffc8':'transparent';
ctx.fillText('Press ENTER to restart',W/2,H*0.72)}

// ========== BACKGROUND ==========
function drawBackground(){
const depth=Math.max(0,player.y);
const [c1,c2]=biomeBg(depth);
const grad=ctx.createLinearGradient(0,0,0,H);
grad.addColorStop(0,c1);grad.addColorStop(1,c2);
ctx.fillStyle=grad;ctx.fillRect(0,0,W,H)}

// ========== MAIN LOOP ==========
function resetGame(){
player.x=20;player.y=-1;player.hp=100;player.gems=0;player.dead=false;
player.pickLevel=0;player.lightRadius=5;player.hasArmor=false;player.hasJetpack=false;
player.bombs=0;player.maxDepth=0;player.totalOres=0;player.dmgCooldown=0;
player.inventory={coal:0,copper:0,iron:0,silver:0,gold:0,sapphire:0,ruby:0,diamond:0,gem:0};
world.clear();chunks.clear();explored.clear();
particles=[];floatingTexts=[];fallingRocks=[];
ensureChunks(player.x,player.y);
shopOpen=false;panel.style.display='none'}

function update(){
time++;
if(gameState==='menu'){
if(keys.enter||keys[' ']||touching){
initAudio();startAmbient();
gameState='playing';resetGame();touching=false}return}
if(gameState==='dead'){
if(keys.enter){gameState='playing';resetGame()}return}
if(gameState==='playing'){
if(keys.e&&!keys._ePrev)toggleShop();
keys._ePrev=keys.e;
if(keys.b&&!keys._bPrev)useBomb();
keys._bPrev=keys.b;
if(!shopOpen){
updatePlayer();updateAmbient()}
updateParticles();updateFloats();updateRocks();updateShake();
// Camera
const targetCamX=player.x*TILE;
const targetCamY=player.y*TILE;
camX+=(targetCamX-camX)*0.12;
camY+=(targetCamY-camY)*0.12}}

function render(){
ctx.clearRect(0,0,W,H);
if(gameState==='menu'){drawMenu();return}
drawBackground();
ctx.save();
ctx.translate(W/2-camX+shakeX,H/2-camY+shakeY);
// Visible tile range
const startTX=Math.floor((camX-W/2)/TILE)-1;
const endTX=Math.ceil((camX+W/2)/TILE)+1;
const startTY=Math.floor((camY-H/2)/TILE)-1;
const endTY=Math.ceil((camY+H/2)/TILE)+1;
for(let ty=startTY;ty<=endTY;ty++){
for(let tx=startTX;tx<=endTX;tx++){
const tile=getTile(tx,ty);
if(tile)drawTile(tx,ty,tile,tx*TILE,ty*TILE)}}
// Particles
particles.forEach(p=>{
ctx.globalAlpha=p.life/p.maxLife;
ctx.fillStyle=p.color;
ctx.fillRect(p.x-p.size/2,p.y-p.size/2,p.size,p.size)});
ctx.globalAlpha=1;
// Floating texts
floatingTexts.forEach(f=>{
ctx.globalAlpha=f.life/60;
ctx.textAlign='center';ctx.font='bold 13px "Courier New"';
ctx.fillStyle=f.color;ctx.shadowColor=f.color;ctx.shadowBlur=6;
ctx.fillText(f.text,f.x,f.y);ctx.shadowBlur=0});
ctx.globalAlpha=1;
// Falling rocks
fallingRocks.forEach(r=>{
ctx.fillStyle='#777';ctx.fillRect(r.x,r.y,r.size,r.size);
ctx.fillStyle='#555';ctx.fillRect(r.x+2,r.y+2,r.size-4,r.size-4)});
// Player
drawPlayer(player.x*TILE,player.y*TILE);
ctx.restore();
// Darkness overlay
drawDarkness();
drawVoidParticles();
// HUD
if(gameState==='playing')drawHUD();
if(gameState==='dead')drawDeath()}

function gameLoop(){update();render();requestAnimationFrame(gameLoop)}
ensureChunks(20,0);
gameLoop();

// Handle enter on start
window.addEventListener('keydown',e=>{
if(e.key==='Enter'){
if(gameState==='menu'){initAudio();startAmbient();gameState='playing';resetGame()}
else if(gameState==='dead'){gameState='playing';resetGame()}}});
canvas.addEventListener('click',()=>{
if(gameState==='menu'){initAudio();startAmbient();gameState='playing';resetGame()}});
</script>
</body>
</html>
